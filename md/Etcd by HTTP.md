# Etcd by HTTP template description

This template is designed to monitor 'etcd' by Zabbix that works without any external scripts.
Most of the metrics are collected in one go, thanks to Zabbix bulk data collection.

The template 'Etcd by HTTP' â€” collects metrics by help of the HTTP agent from '/metrics' endpoint.

Refer to the vendor documentation:
https://etcd.io/docs/v3.5/op-guide/monitoring/#metrics-endpoint

For the users of 'etcd version <= 3.4':

In 'etcd v3.5' some metrics have been deprecated. See more details on 'Upgrade etcd from 3.4 to 3.5':
https://etcd.io/docs/v3.4/upgrades/upgrade_3_5/
Please upgrade your 'etcd' instance, or use older 'Etcd by HTTP' template version.

Setup:

1. Make sure that 'etcd' allows the collection of metrics. You can test it by running:
curl -L http://localhost:2379/metrics

2. Check if 'etcd' is accessible from Zabbix proxy or Zabbix server depending on where you are planning to do the monitoring. To verify it, run:
curl -L  http://<etcd_node_address>:2379/metrics

3. Add the template to the 'etcd' node. Set the hostname or IP address of the 'etcd' host in the '{$ETCD.HOST}' macro. By default, the template uses a client's port.
You can configure metrics endpoint location by adding '--listen-metrics-urls' flag.

For more details, see the etcd documentation:
https://etcd.io/docs/v3.5/op-guide/configuration/#profiling-and-monitoring

Additional points to consider:

- If you have specified a non-standard port for 'etcd', don't forget to change macros: '{$ETCD.SCHEME}' and '{$ETCD.PORT}'.
- You can set '{$ETCD.USERNAME}' and '{$ETCD.PASSWORD}' macros in the template to use on a host level if necessary.
- To test availability, run : 'zabbix_get -s etcd-host -k etcd.health'.

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery gRPC codes discovery ](#discovery_grpc_codes_discovery)
  * [Discovery Peers discovery ](#discovery_peers_discovery)

<a name="items" />

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| Cluster version | The version of the `etcd cluster`. | etcd.cluster.version | DEPENDENT | 0 |
| CPU | The total user and system CPU time spent in seconds. | etcd.cpu.util | DEPENDENT | 0 |
| DB size | The total size of the underlying database. | etcd.db.size | DEPENDENT | 0 |
| Deletes per second | The number of deletes seen by this member per second. | etcd.delete.rate | DEPENDENT | 0 |
| Pending events | The total number of pending events to be sent. | etcd.events.sent.rate | DEPENDENT | 0 |
| Get node metrics | no description | etcd.get_metrics | HTTP_AGENT | no delay |
| Get version | no description | etcd.get_version | HTTP_AGENT | no delay |
| RPCs received per second | The number of RPC stream messages received on the server. | etcd.grpc.received.rate | DEPENDENT | 0 |
| RPCs sent per second | The number of gRPC stream messages sent by the server. | etcd.grpc.sent.rate | DEPENDENT | 0 |
| RPCs started per second | The number of RPCs started on the server. | etcd.grpc.started.rate | DEPENDENT | 0 |
| Server has a leader | It defines - whether or not a leader exists:<br>1 - it exists;<br>0 - it does not. | etcd.has.leader | DEPENDENT | 0 |
| Node health | no description | etcd.health | HTTP_AGENT | no delay |
| HTTP 4XX | The number of handled failures of requests (non-watches), by the method (`GET/PUT` etc.), and the code `4XX`. | etcd.http.requests.4xx.rate | DEPENDENT | 0 |
| HTTP 5XX | The number of handled failures of requests (non-watches), by the method (`GET/PUT` etc.), and the code `5XX`. | etcd.http.requests.5xx.rate | DEPENDENT | 0 |
| HTTP requests received | The number of requests received into the system (successfully parsed and `authd`). | etcd.http.requests.rate | DEPENDENT | 0 |
| Server is a leader | It defines - whether or not this member is a leader:<br>1 - it is;<br>0 - otherwise. | etcd.is.leader | DEPENDENT | 0 |
| Keys compacted per second | The number of DB keys compacted per second. | etcd.keys.compacted.rate | DEPENDENT | 0 |
| Keys expired per second | The number of expired keys per second. | etcd.keys.expired.rate | DEPENDENT | 0 |
| Keys total | The total number of keys. | etcd.keys.total | DEPENDENT | 0 |
| Leader changes | The number of leader changes the member has seen since its start. | etcd.leader.changes | DEPENDENT | 0 |
| Maximum open file descriptors | The Maximum number of open file descriptors. | etcd.max.fds | DEPENDENT | 0 |
| Client gRPC received bytes per second | The number of bytes received from gRPC clients per second. | etcd.network.grpc.received.rate | DEPENDENT | 0 |
| Client gRPC sent bytes per second | The number of bytes sent from gRPC clients per second. | etcd.network.grpc.sent.rate | DEPENDENT | 0 |
| Open file descriptors | The number of open file descriptors. | etcd.open.fds | DEPENDENT | 0 |
| Proposals applied per second | The number of consensus proposals applied. | etcd.proposals.applied.rate | DEPENDENT | 0 |
| Proposals committed per second | The number of consensus proposals committed. | etcd.proposals.committed.rate | DEPENDENT | 0 |
| Proposals failed per second | The number of failed proposals seen. | etcd.proposals.failed.rate | DEPENDENT | 0 |
| Proposals pending | The current number of pending proposals to commit. | etcd.proposals.pending | DEPENDENT | 0 |
| PUT per second | The number of puts seen by this member per second. | etcd.put.rate | DEPENDENT | 0 |
| Range per second | The number of ranges seen by this member per second. | etcd.range.rate | DEPENDENT | 0 |
| Reads per second | The number of read actions by `get/getRecursive`, local to this member. | etcd.reads.rate | DEPENDENT | 0 |
| Resident memory | The size of resident memory expressed in bytes. | etcd.res.bytes | DEPENDENT | 0 |
| Server version | The version of the `etcd server`. | etcd.server.version | DEPENDENT | 0 |
| Transaction per second | The number of transactions seen by this member per second. | etcd.txn.rate | DEPENDENT | 0 |
| Uptime | `Etcd` server uptime. | etcd.uptime | DEPENDENT | 0 |
| Virtual memory | The size of virtual memory expressed in bytes. | etcd.virtual.bytes | DEPENDENT | 0 |
| Writes per second | The number of writes (e.g., `set/compareAndDelete`) seen by this member. | etcd.writes.rate | DEPENDENT | 0 |
| Service's TCP port state | no description | net.tcp.service["{$ETCD.SCHEME}","{$ETCD.HOST}","{$ETCD.PORT}"] | SIMPLE | no delay |


<a name="macros" />

## Macros
| macro | value |
| ------------- |------------- |
| {$ETCD.GRPC.ERRORS.MAX.WARN} | 1 |
| {$ETCD.GRPC_CODE.MATCHES} | .* |
| {$ETCD.GRPC_CODE.NOT_MATCHES} | CHANGE_IF_NEEDED |
| {$ETCD.GRPC_CODE.TRIGGER.MATCHES} | Aborted\|Unavailable |
| {$ETCD.HOST} | <SET ETCD HOST> |
| {$ETCD.HTTP.FAIL.MAX.WARN} | 2 |
| {$ETCD.LEADER.CHANGES.MAX.WARN} | 5 |
| {$ETCD.OPEN.FDS.MAX.WARN} | 90 |
| {$ETCD.PASSWORD} | no value |
| {$ETCD.PORT} | 2379 |
| {$ETCD.PROPOSAL.FAIL.MAX.WARN} | 2 |
| {$ETCD.PROPOSAL.PENDING.MAX.WARN} | 5 |
| {$ETCD.SCHEME} | http |
| {$ETCD.USER} | no value |


<a name="triggers" />

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Cluster version has changed | INFO | Etcd version has changed. Acknowledge to close the problem manually. | last(/Etcd by HTTP/etcd.cluster.version,#1)<>last(/Etcd by HTTP/etcd.cluster.version,#2) and length(last(/Etcd by HTTP/etcd.cluster.version))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| Member has no leader | AVERAGE | If a member does not have a leader, it is totally unavailable. | last(/Etcd by HTTP/etcd.has.leader)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| Node healthcheck failed | AVERAGE | See more details on https://etcd.io/docs/v3.5/op-guide/monitoring/#health-check. | last(/Etcd by HTTP/etcd.health)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| Too many HTTP requests failures | WARNING | Too many requests failed on `etcd` instance with the `5xx HTTP code`. | min(/Etcd by HTTP/etcd.http.requests.5xx.rate,5m)>{$ETCD.HTTP.FAIL.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Failed to fetch info data | WARNING | Zabbix has not received any data for items for the last 30 minutes. | nodata(/Etcd by HTTP/etcd.is.leader,30m)=1 | [{"tag": "scope", "value": "notice"}] | no url |
| Instance has seen too many leader changes | WARNING | Rapid leadership changes impact the performance of `etcd` significantly. It also signals that the leader is unstable, perhaps due to network connectivity issues or excessive load hitting the `etcd cluster`. | (max(/Etcd by HTTP/etcd.leader.changes,15m)-min(/Etcd by HTTP/etcd.leader.changes,15m))>{$ETCD.LEADER.CHANGES.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Too many proposal failures | WARNING | Normally related to two issues: temporary failures related to a leader election or longer downtime caused by a loss of quorum in the cluster. | min(/Etcd by HTTP/etcd.proposals.failed.rate,5m)>{$ETCD.PROPOSAL.FAIL.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Too many proposals are queued to commit | WARNING | Rising pending proposals suggests there is a high client load, or the member cannot commit proposals. | min(/Etcd by HTTP/etcd.proposals.pending,5m)>{$ETCD.PROPOSAL.PENDING.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Server version has changed | INFO | Etcd version has changed. Acknowledge to close the problem manually. | last(/Etcd by HTTP/etcd.server.version,#1)<>last(/Etcd by HTTP/etcd.server.version,#2) and length(last(/Etcd by HTTP/etcd.server.version))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| Host has been restarted | INFO | Uptime is less than 10 minutes. | last(/Etcd by HTTP/etcd.uptime)<10m | [{"tag": "scope", "value": "notice"}] | no url |
| Service is unavailable | AVERAGE | no description | last(/Etcd by HTTP/net.tcp.service["{$ETCD.SCHEME}","{$ETCD.HOST}","{$ETCD.PORT}"])=0 | [{"tag": "scope", "value": "availability"}] | no url |
| Current number of open files is too high | WARNING | Heavy usage of a file descriptor (i.e., near the limit of the process's file descriptor) indicates a potential file descriptor exhaustion issue.<br>If the file descriptors are exhausted, `etcd` may panic because it cannot create new WAL files. | min(/Etcd by HTTP/etcd.open.fds,5m)/last(/Etcd by HTTP/etcd.max.fds)*100>{$ETCD.OPEN.FDS.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |


<a name="discoveries" />

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| gRPC codes discovery | etcd.grpc_code.discovery | no description | DEPENDENT | no lifetime | 0 |
| Peers discovery | etcd.peer.discovery | no description | DEPENDENT | no lifetime | 0 |


<a name="discovery_grpc_codes_discovery" />

## Discovery gRPC codes discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| RPCs completed with code {#GRPC.CODE} | The number of RPCs completed on the server with grpc_code {#GRPC.CODE}. | etcd.grpc.handled.rate[{#GRPC.CODE}] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Too many failed gRPC requests with code: {#GRPC.CODE} | WARNING | no description | min(/Etcd by HTTP/etcd.grpc.handled.rate[{#GRPC.CODE}],5m)>{$ETCD.GRPC.ERRORS.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |


<a name="discovery_peers_discovery" />

## Discovery Peers discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Etcd peer {#ETCD.PEER}: Bytes received | The number of bytes received from a peer with the ID `{#ETCD.PEER}`. | etcd.bytes.received.rate[{#ETCD.PEER}] | DEPENDENT |
| Etcd peer {#ETCD.PEER}: Bytes sent | The number of bytes sent to a peer with the ID `{#ETCD.PEER}`. | etcd.bytes.sent.rate[{#ETCD.PEER}] | DEPENDENT |
| Etcd peer {#ETCD.PEER}: Receive failures | The number of received failures from a peer with the ID `{#ETCD.PEER}`. | etcd.received.fail.rate[{#ETCD.PEER}] | DEPENDENT |
| Etcd peer {#ETCD.PEER}: Send failures | The number of sent failures from a peer with the ID `{#ETCD.PEER}`. | etcd.sent.fail.rate[{#ETCD.PEER}] | DEPENDENT |

