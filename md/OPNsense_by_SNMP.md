# OPNsense by SNMP template description

Template for monitoring OPNsense by SNMP
Setup:
  1. Enable bsnmpd daemon by creating new config file "/etc/rc.conf.d/bsnmpd" with the following content:
  bsnmpd_enable="YES"
  2. Uncomment the following lines in "/etc/snmpd.config" file to enable required SNMP modules:
  begemotSnmpdModulePath."hostres" = "/usr/lib/snmp_hostres.so"
  begemotSnmpdModulePath."pf"     = "/usr/lib/snmp_pf.so"
  3. Start bsnmpd daemon with the following command:
  /etc/rc.d/bsnmpd start
  4. Setup a firewall rule to get access from Zabbix proxy or Zabbix server by SNMP (https://docs.opnsense.org/manual/firewall.html).
  5. Link the template to a host.


MIBs used:
BEGEMOT-PF-MIB
HOST-RESOURCES-MIB

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Network interfaces discovery ](#discovery_network_interfaces_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| DHCP server status | MIB: HOST-RESOURCES-MIB<br>The status of DHCP server process. | opnsense.dhcpd.status | SNMP_AGENT | no delay |
| DNS server status | MIB: HOST-RESOURCES-MIB<br>The status of DNS server process. | opnsense.dns.status | SNMP_AGENT | no delay |
| Web server status | MIB: HOST-RESOURCES-MIB<br>The status of lighttpd process. | opnsense.lighttpd.status | SNMP_AGENT | no delay |
| Packets with bad offset | MIB: BEGEMOT-PF-MIB<br>True if the packet was logged with the specified packet filter reason code. The known codes are: match, bad-offset, fragment, short, normalize, and memory. | opnsense.packets.bad.offset | SNMP_AGENT | no delay |
| Fragmented packets | MIB: BEGEMOT-PF-MIB<br>True if the packet was logged with the specified packet filter reason code. The known codes are: match, bad-offset, fragment, short, normalize, and memory. | opnsense.packets.fragment | SNMP_AGENT | no delay |
| Packets matched a filter rule | MIB: BEGEMOT-PF-MIB<br>True if the packet was logged with the specified packet filter reason code. The known codes are: match, bad-offset, fragment, short, normalize, and memory. | opnsense.packets.match | SNMP_AGENT | no delay |
| Packets dropped due to memory limitation | MIB: BEGEMOT-PF-MIB<br>True if the packet was logged with the specified packet filter reason code. The known codes are: match, bad-offset, fragment, short, normalize, and memory. | opnsense.packets.mem.drop | SNMP_AGENT | no delay |
| Normalized packets | MIB: BEGEMOT-PF-MIB<br>True if the packet was logged with the specified packet filter reason code. The known codes are: match, bad-offset, fragment, short, normalize, and memory. | opnsense.packets.normalize | SNMP_AGENT | no delay |
| Short packets | MIB: BEGEMOT-PF-MIB<br>True if the packet was logged with the specified packet filter reason code. The known codes are: match, bad-offset, fragment, short, normalize, and memory. | opnsense.packets.short | SNMP_AGENT | no delay |
| Packet filter running status | MIB: BEGEMOT-PF-MIB<br>True if packet filter is currently enabled. | opnsense.pf.status | SNMP_AGENT | no delay |
| Firewall rules count | MIB: BEGEMOT-PF-MIB<br>The number of labeled filter rules on this system. | opnsense.rules.count | SNMP_AGENT | no delay |
| Source tracking table current | MIB: BEGEMOT-PF-MIB<br>Number of entries in the source tracking table. | opnsense.source.tracking.table.count | SNMP_AGENT | no delay |
| Source tracking table limit | MIB: BEGEMOT-PF-MIB<br>Maximum number of 'sticky-address' or 'source-track' rules in the ruleset. | opnsense.source.tracking.table.limit | SNMP_AGENT | no delay |
| Source tracking table utilization in % | Utilization of source tracking table in %. | opnsense.source.tracking.table.pused | CALCULATED | no delay |
| States table current | MIB: BEGEMOT-PF-MIB<br>Number of entries in the state table. | opnsense.state.table.count | SNMP_AGENT | no delay |
| States table limit | MIB: BEGEMOT-PF-MIB<br>Maximum number of 'keep state' rules in the ruleset. | opnsense.state.table.limit | SNMP_AGENT | no delay |
| States table utilization in % | Utilization of state table in %. | opnsense.state.table.pused | CALCULATED | no delay |
| SNMP agent availability | Availability of SNMP checks on the host. The value of this item corresponds to availability icons in the host list.<br>Possible values:<br>0 - not available<br>1 - available<br>2 - unknown | zabbix[host,snmp,available] | INTERNAL | no delay |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$IF.ERRORS.WARN} | 2 |
| {$IF.UTIL.MAX} | 90 |
| {$IFCONTROL} | 1 |
| {$NET.IF.IFADMINSTATUS.MATCHES} | ^.* |
| {$NET.IF.IFADMINSTATUS.NOT_MATCHES} | ^2$ |
| {$NET.IF.IFALIAS.MATCHES} | .* |
| {$NET.IF.IFALIAS.NOT_MATCHES} | CHANGE_IF_NEEDED |
| {$NET.IF.IFDESCR.MATCHES} | .* |
| {$NET.IF.IFDESCR.NOT_MATCHES} | CHANGE_IF_NEEDED |
| {$NET.IF.IFNAME.NOT_MATCHES} | (^pflog[0-9.]*$\|^pfsync[0-9.]*$) |
| {$NET.IF.IFOPERSTATUS.MATCHES} | ^.*$ |
| {$NET.IF.IFOPERSTATUS.NOT_MATCHES} | ^6$ |
| {$NET.IF.IFTYPE.MATCHES} | .* |
| {$NET.IF.IFTYPE.NOT_MATCHES} | CHANGE_IF_NEEDED |
| {$SNMP.TIMEOUT} | 5m |
| {$SOURCE.TRACKING.TABLE.UTIL.MAX} | 90 |
| {$STATE.TABLE.UTIL.MAX} | 90 |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| DHCP server is not running | AVERAGE | Please check DHCP server settings. | last(/OPNsense by SNMP/opnsense.dhcpd.status)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| DNS server is not running | AVERAGE | Please check DNS server settings. | last(/OPNsense by SNMP/opnsense.dns.status)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| Web server is not running | AVERAGE | Please check lighttpd service status. | last(/OPNsense by SNMP/opnsense.lighttpd.status)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| Packet filter is not running | HIGH | Please check PF status. | last(/OPNsense by SNMP/opnsense.pf.status)<>1 | [{"tag": "scope", "value": "availability"}] | no url |
| Source tracking table usage is high | WARNING | Please check the number of sticky connections. | min(/OPNsense by SNMP/opnsense.source.tracking.table.pused,#3)>{$SOURCE.TRACKING.TABLE.UTIL.MAX} | [{"tag": "scope", "value": "capacity"}] | no url |
| State table usage is high | WARNING | Please check the number of connections. | min(/OPNsense by SNMP/opnsense.state.table.pused,#3)>{$STATE.TABLE.UTIL.MAX} | [{"tag": "scope", "value": "capacity"}] | no url |
| No SNMP data collection | WARNING | SNMP is not available for polling. Please check device connectivity and SNMP settings. | max(/OPNsense by SNMP/zabbix[host,snmp,available],{$SNMP.TIMEOUT})=0 | [{"tag": "scope", "value": "availability"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Network interfaces discovery | opnsense.net.if.discovery | Discovering interfaces from IF-MIB. | SNMP_AGENT | no lifetime | 1h |


<a name="discovery_network_interfaces_discovery"></a>

## Discovery Network interfaces discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv4 traffic blocked | MIB: BEGEMOT-PF-MIB<br>IPv4 bits per second blocked coming in on this interface. | net.if.in.block.v4.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv4 packets blocked | MIB: BEGEMOT-PF-MIB<br>The number of IPv4 packets blocked coming in on this interface. | net.if.in.block.v4.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv6 traffic blocked | MIB: BEGEMOT-PF-MIB<br>IPv6 bits per second blocked coming in on this interface. | net.if.in.block.v6.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv6 packets blocked | MIB: BEGEMOT-PF-MIB<br>The number of IPv6 packets blocked coming in on this interface. | net.if.in.block.v6.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound packets discarded | MIB: IF-MIB<br>The number of inbound packets which were chosen to be discarded<br>even though no errors had been detected to prevent their being deliverable to a higher-layer protocol.<br>One possible reason for discarding such a packet could be to free up buffer space.<br>Discontinuities in the value of this counter can occur at re-initialization of the management system,<br>and at other times as indicated by the value of ifCounterDiscontinuityTime. | net.if.in.discards[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound packets with errors | MIB: IF-MIB<br>For packet-oriented interfaces, the number of inbound packets that contained errors preventing them from being deliverable to a higher-layer protocol.  For character-oriented or fixed-length interfaces, the number of inbound transmission units that contained errors preventing them from being deliverable to a higher-layer protocol. Discontinuities in the value of this counter can occur at re-initialization of the management system, and at other times as indicated by the value of ifCounterDiscontinuityTime. | net.if.in.errors[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv4 traffic passed | MIB: BEGEMOT-PF-MIB<br>IPv4 bits per second passed coming in on this interface. | net.if.in.pass.v4.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv4 packets passed | MIB: BEGEMOT-PF-MIB<br>The number of IPv4 packets passed coming in on this interface. | net.if.in.pass.v4.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv6 traffic passed | MIB: BEGEMOT-PF-MIB<br>IPv6 bits per second passed coming in on this interface. | net.if.in.pass.v6.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Inbound IPv6 packets passed | MIB: BEGEMOT-PF-MIB<br>The number of IPv6 packets passed coming in on this interface. | net.if.in.pass.v6.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Bits received | MIB: IF-MIB<br>The total number of octets received on the interface, including framing characters. This object is a 64-bit version of ifInOctets. Discontinuities in the value of this counter can occur at re-initialization of the management system, and at other times as indicated by the value of ifCounterDiscontinuityTime. | net.if.in[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv4 traffic blocked | MIB: BEGEMOT-PF-MIB<br>IPv4 bits per second blocked going out on this interface. | net.if.out.block.v4.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv4 packets blocked | MIB: BEGEMOT-PF-MIB<br>The number of IPv4 packets blocked going out on this interface. | net.if.out.block.v4.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv6 traffic blocked | MIB: BEGEMOT-PF-MIB<br>IPv6 bits per second blocked going out on this interface. | net.if.out.block.v6.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv6 packets blocked | MIB: BEGEMOT-PF-MIB<br>The number of IPv6 packets blocked going out on this interface. | net.if.out.block.v6.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound packets discarded | MIB: IF-MIB<br>The number of outbound packets which were chosen to be discarded<br>even though no errors had been detected to prevent their being deliverable to a higher-layer protocol.<br>One possible reason for discarding such a packet could be to free up buffer space.<br>Discontinuities in the value of this counter can occur at re-initialization of the management system,<br>and at other times as indicated by the value of ifCounterDiscontinuityTime. | net.if.out.discards[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound packets with errors | MIB: IF-MIB<br>For packet-oriented interfaces, the number of outbound packets that contained errors preventing them from being deliverable to a higher-layer protocol.  For character-oriented or fixed-length interfaces, the number of outbound transmission units that contained errors preventing them from being deliverable to a higher-layer protocol. Discontinuities in the value of this counter can occur at re-initialization of the management system, and at other times as indicated by the value of ifCounterDiscontinuityTime. | net.if.out.errors[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv4 traffic passed | MIB: BEGEMOT-PF-MIB<br>IPv4 bits per second passed going out on this interface. | net.if.out.pass.v4.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv4 packets passed | MIB: BEGEMOT-PF-MIB<br>The number of IPv4 packets passed going out on this interface. | net.if.out.pass.v4.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv6 traffic passed | MIB: BEGEMOT-PF-MIB<br>IPv6 bits per second passed going out on this interface. | net.if.out.pass.v6.bps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Outbound IPv6 packets passed | MIB: BEGEMOT-PF-MIB<br>The number of IPv6 packets passed going out on this interface. | net.if.out.pass.v6.pps[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Bits sent | MIB: IF-MIB<br>The total number of octets transmitted out of the interface, including framing characters. This object is a 64-bit version of ifOutOctets.Discontinuities in the value of this counter can occur at re-initialization of the management system, and at other times as indicated by the value of ifCounterDiscontinuityTime. | net.if.out[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Rules references count | MIB: BEGEMOT-PF-MIB<br>The number of rules referencing this interface. | net.if.rules.refs[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Speed | MIB: IF-MIB<br>An estimate of the interface's current bandwidth in units of 1,000,000 bits per second. If this object reports a value of `n' then the speed of the interface is somewhere in the range of `n-500,000' to`n+499,999'.  For interfaces which do not vary in bandwidth or for those where no accurate estimation can be made, this object should contain the nominal bandwidth. For a sub-layer which has no concept of bandwidth, this object should be zero. | net.if.speed[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Operational status | MIB: IF-MIB<br>The current operational state of the interface.<br>- The testing(3) state indicates that no operational packet scan be passed<br>- If ifAdminStatus is down(2) then ifOperStatus should be down(2)<br>- If ifAdminStatus is changed to up(1) then ifOperStatus should change to up(1) if the interface is ready to transmit and receive network traffic<br>- It should change todormant(5) if the interface is waiting for external actions (such as a serial line waiting for an incoming connection)<br>- It should remain in the down(2) state if and only if there is a fault that prevents it from going to the up(1) state<br>- It should remain in the notPresent(6) state if the interface has missing(typically, hardware) components. | net.if.status[{#SNMPINDEX}] | SNMP_AGENT |
| Interface [{#IFNAME}({#IFALIAS})]: Interface type | MIB: IF-MIB<br>The type of interface.<br>Additional values for ifType are assigned by the Internet Assigned Numbers Authority (IANA),<br>through updating the syntax of the IANAifType textual convention. | net.if.type[{#SNMPINDEX}] | SNMP_AGENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Interface [{#IFNAME}({#IFALIAS})]: High input error rate | WARNING | It recovers when it is below 80% of the `{$IF.ERRORS.WARN:"{#IFNAME}"}` threshold. | min(/OPNsense by SNMP/net.if.in.errors[{#SNMPINDEX}],5m)>{$IF.ERRORS.WARN:"{#IFNAME}"} | [{"tag": "scope", "value": "availability"}] | no url |
| Interface [{#IFNAME}({#IFALIAS})]: High output error rate | WARNING | It recovers when it is below 80% of the `{$IF.ERRORS.WARN:"{#IFNAME}"}` threshold. | min(/OPNsense by SNMP/net.if.out.errors[{#SNMPINDEX}],5m)>{$IF.ERRORS.WARN:"{#IFNAME}"} | [{"tag": "scope", "value": "availability"}] | no url |
| Interface [{#IFNAME}({#IFALIAS})]: Link down | AVERAGE | This trigger expression works as follows:<br>1. It can be triggered if the operations status is down.<br>2. `{$IFCONTROL:"{#IFNAME}"}=1` - a user can redefine context macro to value - 0. That marks this interface as not important. No new trigger will be fired if this interface is down. | {$IFCONTROL:"{#IFNAME}"}=1 and (last(/OPNsense by SNMP/net.if.status[{#SNMPINDEX}])=2) | [{"tag": "scope", "value": "availability"}] | no url |
| Interface [{#IFNAME}({#IFALIAS})]: Ethernet has changed to lower speed than it was before | INFO | This Ethernet connection has transitioned down from its known maximum speed. This might be a sign of autonegotiation issues. Acknowledge to close the problem manually. | change(/OPNsense by SNMP/net.if.speed[{#SNMPINDEX}])<0 and last(/OPNsense by SNMP/net.if.speed[{#SNMPINDEX}])>0<br>and (<br>last(/OPNsense by SNMP/net.if.type[{#SNMPINDEX}])=6 or<br>last(/OPNsense by SNMP/net.if.type[{#SNMPINDEX}])=7 or<br>last(/OPNsense by SNMP/net.if.type[{#SNMPINDEX}])=11 or<br>last(/OPNsense by SNMP/net.if.type[{#SNMPINDEX}])=62 or<br>last(/OPNsense by SNMP/net.if.type[{#SNMPINDEX}])=69 or<br>last(/OPNsense by SNMP/net.if.type[{#SNMPINDEX}])=117<br>)<br>and<br>(last(/OPNsense by SNMP/net.if.status[{#SNMPINDEX}])<>2) | [{"tag": "scope", "value": "capacity"}] | no url |
| Interface [{#IFNAME}({#IFALIAS})]: High inbound bandwidth usage | WARNING | The utilization of the network interface is close to its estimated maximum bandwidth. | (avg(/OPNsense by SNMP/net.if.in[{#SNMPINDEX}],15m)>({$IF.UTIL.MAX:"{#IFNAME}"}/100)*last(/OPNsense by SNMP/net.if.speed[{#SNMPINDEX}])) and<br>last(/OPNsense by SNMP/net.if.speed[{#SNMPINDEX}])>0 | [{"tag": "scope", "value": "performance"}] | no url |
| Interface [{#IFNAME}({#IFALIAS})]: High outbound bandwidth usage | WARNING | The utilization of the network interface is close to its estimated maximum bandwidth. | (avg(/OPNsense by SNMP/net.if.out[{#SNMPINDEX}],15m)>({$IF.UTIL.MAX:"{#IFNAME}"}/100)*last(/OPNsense by SNMP/net.if.speed[{#SNMPINDEX}])) and<br>last(/OPNsense by SNMP/net.if.speed[{#SNMPINDEX}])>0 | [{"tag": "scope", "value": "performance"}] | no url |

