# TiDB by HTTP template description

The template to monitor TiDB server of TiDB cluster by Zabbix that works without any external scripts.
Most of the metrics are collected in one go, thanks to Zabbix bulk data collection.
Don't forget to change the macros {$TIDB.URL}, {$TIDB.PORT}.

Template `TiDB by HTTP` â€” collects metrics by HTTP agent from PD /metrics endpoint and from monitoring API.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery KV metrics discovery ](#discovery_kv_metrics_discovery)
  * [Discovery QPS metrics discovery ](#discovery_qps_metrics_discovery)
  * [Discovery Statement metrics discovery ](#discovery_statement_metrics_discovery)
  * [Discovery KV backoff discovery ](#discovery_kv_backoff_discovery)
  * [Discovery GC action results discovery ](#discovery_gc_action_results_discovery)
  * [Discovery Lock resolves discovery ](#discovery_lock_resolves_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| CPU | Total user and system CPU usage ratio. | tidb.cpu.util | DEPENDENT | 0 |
| DDL waiting jobs | The number of TiDB operations that resolve locks per second. When TiDB's read or write request encounters a lock, it tries to resolve the lock. | tidb.ddl_waiting_jobs | DEPENDENT | 0 |
| Load schema failed, rate | The total number of failures to reload the latest schema information in TiDB per second. | tidb.domain_load_schema.failed.rate | DEPENDENT | 0 |
| Load schema total, rate | The statistics of the schemas that TiDB obtains from TiKV per second. | tidb.domain_load_schema.rate | DEPENDENT | 0 |
| Failed Query, rate | The number of error occurred when executing SQL statements per second (such as syntax errors and primary key conflicts). | tidb.execute_error.rate | DEPENDENT | 0 |
| Get instance metrics | Get TiDB instance metrics. | tidb.get_metrics | HTTP_AGENT | no delay |
| Get instance status | Get TiDB instance status info. | tidb.get_status | HTTP_AGENT | no delay |
| Goroutine count | The number of Goroutines on TiDB instance. | tidb.goroutines | DEPENDENT | 0 |
| Heap memory usage | Number of heap bytes that are in use. | tidb.heap_bytes | DEPENDENT | 0 |
| Keep alive, rate | The number of times that the metrics are refreshed on TiDB instance per minute. | tidb.monitor_keep_alive.rate | DEPENDENT | 0 |
| Time jump back, rate | The number of times that the operating system rewinds every second. | tidb.monitor_time_jump_back.rate | DEPENDENT | 0 |
| PD TSO commands, rate | The number of TSO commands that TiDB obtains from PD per second. | tidb.pd_tso_cmd.rate | DEPENDENT | 0 |
| PD TSO requests, rate | The number of TSO requests that TiDB obtains from PD per second. | tidb.pd_tso_request.rate | DEPENDENT | 0 |
| Open file descriptors, max | Maximum number of open file descriptors. | tidb.process_max_fds | DEPENDENT | 0 |
| Open file descriptors | Number of open file descriptors. | tidb.process_open_fds | DEPENDENT | 0 |
| RSS memory usage | Resident memory size in bytes. | tidb.rss_bytes | DEPENDENT | 0 |
| Total "error" server query, rate | The number of queries on TiDB instance per second with failure of command execution results. | tidb.server_query.error.rate | DEPENDENT | 0 |
| Get total server query metrics | Get information about server queries. | tidb.server_query.get_metrics | DEPENDENT | 0 |
| Total "ok" server query, rate | The number of queries on TiDB instance per second with success of command execution results. | tidb.server_query.ok.rate | DEPENDENT | 0 |
| Total server query, rate | The number of queries per second on TiDB instance. | tidb.server_query.rate | DEPENDENT | 0 |
| Schema lease "change" errors, rate | The number of schema lease errors per second.<br>"change" means that the schema has changed | tidb.session_schema_lease_error.change.rate | DEPENDENT | 0 |
| Schema lease "outdate" errors , rate | The number of schema lease errors per second.<br>"outdate" errors means that the schema cannot be updated, which is a more serious error and triggers an alert. | tidb.session_schema_lease_error.outdate.rate | DEPENDENT | 0 |
| Get SQL statements metrics | Get SQL statements metrics. | tidb.statement_total.get_metrics | DEPENDENT | 0 |
| SQL statements, rate | The total number of SQL statements executed per second. | tidb.statement_total.rate | DEPENDENT | 0 |
| Status | Status of PD instance. | tidb.status | DEPENDENT | 0 |
| Server connections | The connection number of current TiDB instance. | tidb.tidb_server_connections | DEPENDENT | 0 |
| Server critical error, rate | The number of critical errors occurred in TiDB per second. | tidb.tidb_server_critical_error_total.rate | DEPENDENT | 0 |
| Server panic, rate | The number of panics occurred in TiDB per second. | tidb.tidb_server_panic_total.rate | DEPENDENT | 0 |
| Get TiKV client metrics | Get TiKV client metrics. | tidb.tikvclient.get_metrics | DEPENDENT | 0 |
| KV backoff, rate | The number of errors returned by TiKV. | tidb.tikvclient_backoff.rate | DEPENDENT | 0 |
| Lock resolves, rate | The number of DDL tasks that are waiting. | tidb.tikvclient_lock_resolver_action.rate | DEPENDENT | 0 |
| TiClient region errors, rate | The number of region related errors returned by TiKV per second. | tidb.tikvclient_region_err.rate | DEPENDENT | 0 |
| KV commands, rate | The number of executed KV commands per second. | tidb.tikvclient_txn.rate | DEPENDENT | 0 |
| Uptime | The runtime of each TiDB instance. | tidb.uptime | DEPENDENT | 0 |
| Version | Version of the TiDB instance. | tidb.version | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$TIDB.DDL.WAITING.MAX.WARN} | 5 |
| {$TIDB.GC_ACTIONS.ERRORS.MAX.WARN} | 1 |
| {$TIDB.HEAP.USAGE.MAX.WARN} | 10G |
| {$TIDB.MONITOR_KEEP_ALIVE.MAX.WARN} | 10 |
| {$TIDB.OPEN.FDS.MAX.WARN} | 90 |
| {$TIDB.PORT} | 10080 |
| {$TIDB.REGION_ERROR.MAX.WARN} | 50 |
| {$TIDB.SCHEMA_LEASE_ERRORS.MAX.WARN} | 0 |
| {$TIDB.SCHEMA_LOAD_ERRORS.MAX.WARN} | 1 |
| {$TIDB.TIME_JUMP_BACK.MAX.WARN} | 1 |
| {$TIDB.URL} | localhost |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Too many DDL waiting jobs | WARNING | no description | min(/TiDB by HTTP/tidb.ddl_waiting_jobs,5m)>{$TIDB.DDL.WAITING.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Too many schema lease errors | AVERAGE | no description | min(/TiDB by HTTP/tidb.domain_load_schema.failed.rate,5m)>{$TIDB.SCHEMA_LOAD_ERRORS.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Heap memory usage is too high | WARNING | no description | min(/TiDB by HTTP/tidb.heap_bytes,5m)>{$TIDB.HEAP.USAGE.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |
| Too few keep alive operations | AVERAGE | Indicates whether the TiDB process still exists. If the number of times for tidb_monitor_keep_alive_total increases less than 10 per minute, the TiDB process might already exit and an alert is triggered. | max(/TiDB by HTTP/tidb.monitor_keep_alive.rate,5m)<{$TIDB.MONITOR_KEEP_ALIVE.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Too many time jump backs | WARNING | no description | min(/TiDB by HTTP/tidb.monitor_time_jump_back.rate,5m)>{$TIDB.TIME_JUMP_BACK.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Too many schema lease errors | AVERAGE | The latest schema information is not reloaded in TiDB within one lease. | min(/TiDB by HTTP/tidb.session_schema_lease_error.outdate.rate,5m)>{$TIDB.SCHEMA_LEASE_ERRORS.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Instance is not responding | AVERAGE | no description | last(/TiDB by HTTP/tidb.status)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| There are panicked TiDB threads | AVERAGE | When a panic occurs, an alert is triggered. The thread is often recovered, otherwise, TiDB will frequently restart. | last(/TiDB by HTTP/tidb.tidb_server_panic_total.rate)>0 | [{"tag": "scope", "value": "availability"}] | no url |
| Too many region related errors | AVERAGE | no description | min(/TiDB by HTTP/tidb.tikvclient_region_err.rate,5m)>{$TIDB.REGION_ERROR.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| has been restarted | INFO | Uptime is less than 10 minutes. | last(/TiDB by HTTP/tidb.uptime)<10m | [{"tag": "scope", "value": "notice"}] | no url |
| Version has changed | INFO | TiDB version has changed. Acknowledge to close the problem manually. | last(/TiDB by HTTP/tidb.version,#1)<>last(/TiDB by HTTP/tidb.version,#2) and length(last(/TiDB by HTTP/tidb.version))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| Current number of open files is too high | WARNING | Heavy file descriptor usage (i.e., near the process's file descriptor limit) indicates a potential file descriptor exhaustion issue. | min(/TiDB by HTTP/tidb.process_open_fds,5m)/last(/TiDB by HTTP/tidb.process_max_fds)*100>{$TIDB.OPEN.FDS.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| KV metrics discovery | tidb.kv_ops.discovery | Discovery KV specific metrics. | DEPENDENT | no lifetime | 0 |
| QPS metrics discovery | tidb.qps.discovery | Discovery QPS specific metrics. | DEPENDENT | no lifetime | 0 |
| Statement metrics discovery | tidb.statement.discover | Discovery statement specific metrics. | DEPENDENT | no lifetime | 0 |
| KV backoff discovery | tidb.tikvclient_backoff.discovery | Discovery KV backoff specific metrics. | DEPENDENT | no lifetime | 0 |
| GC action results discovery | tidb.tikvclient_gc_action.discovery | Discovery GC action results metrics. | DEPENDENT | no lifetime | 0 |
| Lock resolves discovery | tidb.tikvclient_lock_resolver_action.discovery | Discovery lock resolves specific metrics. | DEPENDENT | no lifetime | 0 |


<a name="discovery_kv_metrics_discovery" />

## Discovery KV metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| KV Commands: {#TYPE}, rate | The number of executed KV commands per second. | tidb.tikvclient_txn.rate[{#TYPE}] | DEPENDENT |


<a name="discovery_qps_metrics_discovery" />

## Discovery QPS metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Get QPS metrics: {#TYPE} | Get QPS metrics of {#TYPE}. | tidb.qps.get_metrics[{#TYPE}] | DEPENDENT |
| Server query "Error": {#TYPE}, rate | The number of queries on TiDB instance per second with failure of command execution results. | tidb.server_query.error.rate[{#TYPE}] | DEPENDENT |
| Server query "OK": {#TYPE}, rate | The number of queries on TiDB instance per second with success of command execution results. | tidb.server_query.ok.rate[{#TYPE}] | DEPENDENT |


<a name="discovery_statement_metrics_discovery" />

## Discovery Statement metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| SQL statements: {#TYPE}, rate | The number of SQL statements executed per second. | tidb.statement.rate[{#TYPE}] | DEPENDENT |


<a name="discovery_kv_backoff_discovery" />

## Discovery KV backoff discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| KV backoff: {#TYPE}, rate | The number of TiDB operations that resolve locks per second. When TiDB's read or write request encounters a lock, it tries to resolve the lock. | tidb.tikvclient_backoff.rate[{#TYPE}] | DEPENDENT |


<a name="discovery_gc_action_results_discovery" />

## Discovery GC action results discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| GC action result: {#TYPE}, rate | The number of results of GC-related operations per second. | tidb.tikvclient_gc_action.rate[{#TYPE}] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Too many failed GC-related operations | WARNING | no description | min(/TiDB by HTTP/tidb.tikvclient_gc_action.rate[{#TYPE}],5m)>{$TIDB.GC_ACTIONS.ERRORS.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |


<a name="discovery_lock_resolves_discovery" />

## Discovery Lock resolves discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Lock resolves: {#TYPE}, rate | The number of TiDB operations that resolve locks per second. When TiDB's read or write request encounters a lock, it tries to resolve the lock. | tidb.tikvclient_lock_resolver_action.rate[{#TYPE}] | DEPENDENT |

