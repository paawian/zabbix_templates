# HashiCorp Consul Node by HTTP template description

Get HashiCorp Consul Node metrics by HTTP agent from metrics endpoint.

Don't forget to change macros {$CONSUL.NODE.API.URL}, {$CONSUL.TOKEN}.
Some metrics may not be collected depending on your HashiCorp Consul instance version and configuration.
More information about metrics you can find in official documentation: https://www.consul.io/docs/agent/telemetry

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery HTTP API methods discovery ](#discovery_http_api_methods_discovery)
  * [Discovery Local node services discovery ](#discovery_local_node_services_discovery)
  * [Discovery Raft leader metrics discovery ](#discovery_raft_leader_metrics_discovery)
  * [Discovery Raft server metrics discovery ](#discovery_raft_server_metrics_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| ACL: resolves, rate | The number of ACL resolves per second. | consul.acl.resolves.rate | DEPENDENT | 0 |
| Catalog: deregister, rate | The number of catalog deregister operation per second. | consul.catalog.deregister.rate | DEPENDENT | 0 |
| Catalog: register, rate | The number of catalog register operation per second. | consul.catalog.register.rate | DEPENDENT | 0 |
| Number of checks | Number of checks on current node. | consul.checks_number | DEPENDENT | 0 |
| Number of check monitors | Number of check monitors on current node. | consul.check_monitors_number | DEPENDENT | 0 |
| Client RPC, per second | Number of times per second whenever a Consul agent in client mode makes an RPC request to a Consul server.<br>This gives a measure of how much a given agent is loading the Consul servers.<br>This is only generated by agents in client mode, not Consul servers. | consul.client_rpc | DEPENDENT | 0 |
| Client RPC failed ,per second | Number of times per second whenever a Consul agent in client mode makes an RPC request to a Consul server and fails. | consul.client_rpc_failed | DEPENDENT | 0 |
| Process CPU seconds, total | Total user and system CPU time spent in seconds. | consul.cpu_seconds_total.rate | DEPENDENT | 0 |
| GC pause, p50 | The 50 percentile (median) for the number of nanoseconds consumed by stop-the-world garbage collection (GC) pauses since Consul started, in milliseconds. | consul.gc_pause.p50 | DEPENDENT | 0 |
| GC pause, p90 | The 90 percentile for the number of nanoseconds consumed by stop-the-world garbage collection (GC) pauses since Consul started, in milliseconds. | consul.gc_pause.p90 | DEPENDENT | 0 |
| Get local services | Get all the services that are registered with the local agent and their status. | consul.get_local_services | SCRIPT | no delay |
| Get local services check | Data collection check. | consul.get_local_services.check | DEPENDENT | 0 |
| Get instance metrics | Get raw metrics from Consul instance /metrics endpoint. | consul.get_metrics | HTTP_AGENT | no delay |
| Get node info | Get configuration and member information of the local agent. | consul.get_node_info | HTTP_AGENT | no delay |
| Goroutine count | The number of Goroutines on Consul instance. | consul.goroutines | DEPENDENT | 0 |
| KV store: apply, p50 | The 50 percentile (median) for the time it takes to complete an update to the KV store. | consul.kvs.apply.p50 | DEPENDENT | 0 |
| KV store: apply, p90 | The 90 percentile for the time it takes to complete an update to the KV store. | consul.kvs.apply.p90 | DEPENDENT | 0 |
| KV store: apply, rate | The number of updates to the KV store per second. | consul.kvs.apply.rate | DEPENDENT | 0 |
| Memberlist: degraded | This metric counts the number of times the Consul agent has performed failure detection on another agent at a slower probe rate.<br>The agent uses its own health metric as an indicator to perform this action.<br>If its health score is low, it means that the node is healthy, and vice versa. | consul.memberlist.degraded | DEPENDENT | 0 |
| Memberlist: gossip, p90 | The 90 percentile for the number of gossips (messages) broadcasted to a set of randomly selected nodes. | consul.memberlist.dispatch_log.p90 | DEPENDENT | 0 |
| Memberlist: gossip, p50 | The 50 for the number of gossips (messages) broadcasted to a set of randomly selected nodes. | consul.memberlist.gossip.p50 | DEPENDENT | 0 |
| Memberlist: health score | This metric describes a node's perception of its own health based on how well it is meeting the soft real-time requirements of the protocol.<br>This metric ranges from 0 to 8, where 0 indicates "totally healthy". | consul.memberlist.health_score | DEPENDENT | 0 |
| Memberlist: msg alive | This metric counts the number of alive Consul agents, that the agent has mapped out so far, based on the message information given by the network layer. | consul.memberlist.msg.alive | DEPENDENT | 0 |
| Memberlist: msg dead | This metric counts the number of times a Consul agent has marked another agent to be a dead node. | consul.memberlist.msg.dead | DEPENDENT | 0 |
| Memberlist: msg suspect | The number of times a Consul agent suspects another as failed while probing during gossip protocol. | consul.memberlist.msg.suspect | DEPENDENT | 0 |
| Memberlist: probe node, p50 | The 50 percentile (median) for the time taken to perform a single round of failure detection on a select Consul agent. | consul.memberlist.probe_node.p50 | DEPENDENT | 0 |
| Memberlist: probe node, p90 | The 90 percentile for the time taken to perform a single round of failure detection on a select Consul agent. | consul.memberlist.probe_node.p90 | DEPENDENT | 0 |
| Memberlist: push pull node, p50 | The 50 percentile (median) for the number of Consul agents that have exchanged state with this agent. | consul.memberlist.push_pull_node.p50 | DEPENDENT | 0 |
| Memberlist: push pull node, p90 | The 90 percentile for the number of Consul agents that have exchanged state with this agent. | consul.memberlist.push_pull_node.p90 | DEPENDENT | 0 |
| TCP connections, accepted per second | This metric counts the number of times a Consul agent has accepted an incoming TCP stream connection per second. | consul.memberlist.tcp_accept | DEPENDENT | 0 |
| TCP connections, per second | This metric counts the number of times a Consul agent has initiated a push/pull sync with an other agent per second. | consul.memberlist.tcp_connect | DEPENDENT | 0 |
| TCP send bytes, per second | This metric measures the total number of bytes sent by a Consul agent through the TCP protocol per second. | consul.memberlist.tcp_sent | DEPENDENT | 0 |
| UDP received bytes, per second | This metric measures the total number of bytes received by a Consul agent through the UDP protocol per second. | consul.memberlist.udp_received | DEPENDENT | 0 |
| UDP sent bytes, per second | This metric measures the total number of bytes sent by a Consul agent through the UDP protocol per second. | consul.memberlist.udp_sent | DEPENDENT | 0 |
| Open file descriptors, max | Maximum number of open file descriptors. | consul.process_max_fds | DEPENDENT | 0 |
| Open file descriptors | Number of open file descriptors. | consul.process_open_fds | DEPENDENT | 0 |
| RSS memory usage | Resident memory size in bytes. | consul.resident_memory_bytes | DEPENDENT | 0 |
| Role | Role of current Consul agent. | consul.role | DEPENDENT | 0 |
| Serf member: failed, rate | Increments when an agent is marked dead.<br>This can be an indicator of overloaded agents, network problems, or configuration errors where agents cannot connect to each other on the required ports.<br>Shown as events per second. | consul.serf.member.failed.rate | DEPENDENT | 0 |
| Serf member: flap, rate | Increments when an agent is marked dead and then recovers within a short time period.<br>This can be an indicator of overloaded agents, network problems, or configuration errors where agents cannot connect to each other on the required ports.<br>Shown as events per second. | consul.serf.member.flap.rate | DEPENDENT | 0 |
| Serf member: join, rate | Increments when an agent joins the cluster. If an agent flapped or failed this counter also increments when it re-joins.<br>Shown as events per second. | consul.serf.member.join.rate | DEPENDENT | 0 |
| Serf member: left, rate | Increments when an agent leaves the cluster. Shown as events per second. | consul.serf.member.left.rate | DEPENDENT | 0 |
| Serf member: update, rate | Increments when a Consul agent updates. Shown as events per second. | consul.serf.member.update.rate | DEPENDENT | 0 |
| Number of services | Number of services on current node. | consul.services_number | DEPENDENT | 0 |
| Snapshot: append line, p50 | The 50 percentile (median) for the time taken by the Consul agent to append an entry into the existing log. | consul.snapshot.append_line.p50 | DEPENDENT | 0 |
| Snapshot: append line, p90 | The 90 percentile for the time taken by the Consul agent to append an entry into the existing log. | consul.snapshot.append_line.p90 | DEPENDENT | 0 |
| Snapshot: append line, rate | The number of snapshot appendLine operations per second. | consul.snapshot.append_line.rate | DEPENDENT | 0 |
| Snapshot: compact, p50 | The 50 percentile (median) for the time taken by the Consul agent to compact a log.<br>This operation occurs only when the snapshot becomes large enough to justify the compaction. | consul.snapshot.compact.p50 | DEPENDENT | 0 |
| Snapshot: compact, p90 | The 90 percentile for the time taken by the Consul agent to compact a log.<br>This operation occurs only when the snapshot becomes large enough to justify the compaction. | consul.snapshot.compact.p90 | DEPENDENT | 0 |
| Snapshot: compact, rate | The number of snapshot compact operations per second. | consul.snapshot.compact.rate | DEPENDENT | 0 |
| Version | Version of Consul agent. | consul.version | DEPENDENT | 0 |
| Virtual memory size | Virtual memory size in bytes. | consul.virtual_memory_bytes | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$CONSUL.LLD.FILTER.LOCAL_SERVICE_NAME.MATCHES} | .* |
| {$CONSUL.LLD.FILTER.LOCAL_SERVICE_NAME.NOT_MATCHES} | CHANGE IF NEEDED |
| {$CONSUL.LLD.FILTER.SERVICE_NAMESPACE.MATCHES} | .* |
| {$CONSUL.LLD.FILTER.SERVICE_NAMESPACE.NOT_MATCHES} | CHANGE IF NEEDED |
| {$CONSUL.NODE.API.URL} | http://localhost:8500 |
| {$CONSUL.NODE.HEALTH_SCORE.MAX.HIGH} | 4 |
| {$CONSUL.NODE.HEALTH_SCORE.MAX.WARN} | 2 |
| {$CONSUL.OPEN.FDS.MAX.WARN} | 90 |
| {$CONSUL.TOKEN} | <PUT YOUR AUTH TOKEN> |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Failed to get local services | WARNING | Failed to get local services. Check debug log for more information. | length(last(/HashiCorp Consul Node by HTTP/consul.get_local_services.check))>0 | [{"tag": "scope", "value": "availability"}] | no url |
| Node's health score is critical | AVERAGE | This metric ranges from 0 to 8, where 0 indicates "totally healthy".<br>This health score is used to scale the time between outgoing probes, and higher scores translate into longer probing intervals.<br>For more details see section IV of the Lifeguard paper: https://arxiv.org/pdf/1707.00788.pdf | max(/HashiCorp Consul Node by HTTP/consul.memberlist.health_score,#3)>{$CONSUL.NODE.HEALTH_SCORE.MAX.HIGH} | [{"tag": "scope", "value": "availability"}] | no url |
| Node's health score is warning | WARNING | This metric ranges from 0 to 8, where 0 indicates "totally healthy".<br>This health score is used to scale the time between outgoing probes, and higher scores translate into longer probing intervals.<br>For more details see section IV of the Lifeguard paper: https://arxiv.org/pdf/1707.00788.pdf | max(/HashiCorp Consul Node by HTTP/consul.memberlist.health_score,#3)>{$CONSUL.NODE.HEALTH_SCORE.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Version has been changed | INFO | Consul version has changed. Acknowledge to close the problem manually. | last(/HashiCorp Consul Node by HTTP/consul.version,#1)<>last(/HashiCorp Consul Node by HTTP/consul.version,#2) and length(last(/HashiCorp Consul Node by HTTP/consul.version))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| Current number of open files is too high | WARNING | "Heavy file descriptor usage (i.e., near the processâ€™s file descriptor limit) indicates a potential file descriptor exhaustion issue." | min(/HashiCorp Consul Node by HTTP/consul.process_open_fds,5m)/last(/HashiCorp Consul Node by HTTP/consul.process_max_fds)*100>{$CONSUL.OPEN.FDS.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| HTTP API methods discovery | consul.http_api_discovery | Discovery HTTP API methods specific metrics. | DEPENDENT | no lifetime | 0 |
| Local node services discovery | consul.node_services_lld | Discover metrics for services that are registered with the local agent. | DEPENDENT | no lifetime | 0 |
| Raft leader metrics discovery | consul.raft.leader.discovery | Discover raft metrics for leader nodes. | DEPENDENT | no lifetime | 0 |
| Raft server metrics discovery | consul.raft.server.discovery | Discover raft metrics for server nodes. | DEPENDENT | no lifetime | 0 |


<a name="discovery_http_api_methods_discovery"></a>

## Discovery HTTP API methods discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| HTTP request: ["{#HTTP_METHOD}"], p50 | The 50 percentile (median) of how long it takes to service the given HTTP request for the given verb. | consul.http.api.p50["{#HTTP_METHOD}"] | DEPENDENT |
| HTTP request: ["{#HTTP_METHOD}"], p90 | The 90 percentile of how long it takes to service the given HTTP request for the given verb. | consul.http.api.p90["{#HTTP_METHOD}"] | DEPENDENT |
| HTTP request: ["{#HTTP_METHOD}"], rate | The number of HTTP request for the given verb per second. | consul.http.api.rate["{#HTTP_METHOD}"] | DEPENDENT |


<a name="discovery_local_node_services_discovery"></a>

## Discovery Local node services discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| ["{#SERVICE_NAME}"]: Aggregated status | Aggregated values of all health checks for the service instance. | consul.service.aggregated_state["{#SERVICE_ID}"] | DEPENDENT |
| ["{#SERVICE_NAME}"]: Check ["{#SERVICE_CHECK_NAME}"]: Output | Current output of health check for the service. | consul.service.check.output["{#SERVICE_ID}/{#SERVICE_CHECK_ID}"] | DEPENDENT |
| ["{#SERVICE_NAME}"]: Check ["{#SERVICE_CHECK_NAME}"]: Status | Current state of health check for the service. | consul.service.check.state["{#SERVICE_ID}/{#SERVICE_CHECK_ID}"] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Aggregated status is 'critical' | AVERAGE | Aggregated state of service on the local agent is 'critical'. | last(/HashiCorp Consul Node by HTTP/consul.service.aggregated_state["{#SERVICE_ID}"]) = 2 | [{"tag": "scope", "value": "availability"}] | no url |
| Aggregated status is 'warning' | WARNING | Aggregated state of service on the local agent is 'warning'. | last(/HashiCorp Consul Node by HTTP/consul.service.aggregated_state["{#SERVICE_ID}"]) = 1 | [{"tag": "scope", "value": "availability"}] | no url |


<a name="discovery_raft_leader_metrics_discovery"></a>

## Discovery Raft leader metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Autopilot healthy | Tracks the overall health of the local server cluster. 1 if all servers are healthy, 0 if one or more are unhealthy. | consul.autopilot.healthy[{#SINGLETON}] | DEPENDENT |
| Raft state: commit time, p50 | The 50 percentile (median) time it takes to commit a new entry to the raft log on the leader, in milliseconds. | consul.raft.commit_time.p50[{#SINGLETON}] | DEPENDENT |
| Raft state: commit time, p90 | The 90 percentile time it takes to commit a new entry to the raft log on the leader, in milliseconds. | consul.raft.commit_time.p90[{#SINGLETON}] | DEPENDENT |
| Raft state: commit, rate | The number of commits a new entry to the Raft log on the leader per second. | consul.raft.commit_time.rate[{#SINGLETON}] | DEPENDENT |
| Raft state: dispatch log, p50 | The 50 percentile (median) time it takes for the leader to write log entries to disk, in milliseconds. | consul.raft.dispatch_log.p50[{#SINGLETON}] | DEPENDENT |
| Raft state: dispatch log, p90 | The 90 percentile time it takes for the leader to write log entries to disk, in milliseconds. | consul.raft.dispatch_log.p90[{#SINGLETON}] | DEPENDENT |
| Raft state: dispatch log, rate | The number of times a Raft leader writes a log to disk per second. | consul.raft.dispatch_log.rate[{#SINGLETON}] | DEPENDENT |
| Raft state: leader last contact, p50 | The 50 percentile (median) of how long it takes a leader node to communicate with followers during a leader lease check, in milliseconds. | consul.raft.leader_last_contact.p50[{#SINGLETON}] | DEPENDENT |
| Raft state: leader last contact, p90 | The 90 percentile of how long it takes a leader node to communicate with followers during a leader lease check, in milliseconds. | consul.raft.leader_last_contact.p90[{#SINGLETON}] | DEPENDENT |


<a name="discovery_raft_server_metrics_discovery"></a>

## Discovery Raft server metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Raft: apply, rate | Incremented whenever a leader first passes a message into the Raft commit process (called an Apply operation).<br>This metric describes the arrival rate of new logs into Raft per second. | consul.raft.apply.rate[{#SINGLETON}] | DEPENDENT |
| Raft state | Current state of Consul agent. | consul.raft.state[{#SINGLETON}] | DEPENDENT |
| Raft state: candidate | The number of initiated leader elections. | consul.raft.state_candidate[{#SINGLETON}] | DEPENDENT |
| Raft state: leader | Increments when a server becomes a leader. | consul.raft.state_leader[{#SINGLETON}] | DEPENDENT |

