# Template: PostgreSQL by Zabbix agent 2

## Template ID
10329

## Description
This template is designed for the deployment of PostgreSQL monitoring by Zabbix via Zabbix agent 2 and uses a loadable plugin to run SQL queries.

Setup:

1. Deploy Zabbix agent 2 with the PostgreSQL plugin. Starting with Zabbix versions 6.0.10 / 6.2.4 / 6.4 PostgreSQL metrics are moved to a loadable plugin and require installation of a separate package or compilation of the plugin from sources (https://www.zabbix.com/documentation/7.0/manual/extensions/plugins/build).

2. Create the PostgreSQL user for monitoring (`<password>` at your discretion) and inherit permissions from the default role `pg_monitor`:
CREATE USER zbx_monitor WITH PASSWORD '<PASSWORD>' INHERIT;
GRANT pg_monitor TO zbx_monitor;

3. Edit the `pg_hba.conf` configuration file to allow connections for the user `zbx_monitor`. You can check the PostgreSQL documentation for examples (https://www.postgresql.org/docs/current/auth-pg-hba-conf.html).

4. Set the connection string for the PostgreSQL instance in the `{$PG.CONNSTRING}` macro as URI, such as `<protocol(host:port)>`, or specify the named session - `<sessionname>`.

Note: if you want to use SSL/TLS encryption to protect communications with the remote PostgreSQL instance, a named session must be used. In that case, the instance URI should be specified in the `Plugins.PostgreSQL.Sessions.*.Uri` parameter in the PostgreSQL plugin configuration files alongside all the encryption parameters (type, cerfiticate/key filepaths if needed etc.).

You can check the PostgreSQL plugin documentation (https://git.zabbix.com/projects/AP/repos/postgresql/browse?at=refs%2Fheads%2Frelease%2F7.0) for details about agent plugin parameters and named sessions.

Also, it is assumed that you set up the PostgreSQL instance to work in the desired encryption mode. Check the PostgreSQL documentation (https://www.postgresql.org/docs/current/ssl-tcp.html) for details.

Note that plugin TLS certificate validation relies on checking the Subject Alternative Names (SAN) instead of the Common Name (CN), check the cryptography package documentation (https://pkg.go.dev/crypto/x509) for details.

For example, to enable required encryption in transport mode without identity checks you could create the file `/etc/zabbix/zabbix_agent2.d/postgresql_myconn.conf` with the following configuration for the named session `myconn` (replace `<instanceip>` with the address of the PostgreSQL instance):
Plugins.PostgreSQL.Sessions.myconn.Uri=tcp://<instanceip>:5432
Plugins.PostgreSQL.Sessions.myconn.TLSConnect=required

Then set the `{$PG.CONNSTRING}` macro to `myconn` to use this named session.

5. Set the password that you specified in step 2 in the macro `{$PG.PASSWORD}`.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback/384190-%C2%A0discussion-thread-for-official-zabbix-template-db-postgresql

Generated by official Zabbix template tool "Templator"

## Linked Hosts
None

## Items

### Item: Get archive
- **Description**: Collect archive status metrics.
- **Interval**: 1m
- **Data Type**: 4

### Item: Archive: Count of archived files
- **Description**: Count of archived files.
- **Interval**: 0
- **Data Type**: 0

### Item: Archive: Count of files in archive_status need to archive
- **Description**: Count of files to archive.
- **Interval**: 0
- **Data Type**: 0

### Item: Archive: Count of failed attempts to archive files
- **Description**: Count of failed attempts to archive files.
- **Interval**: 0
- **Data Type**: 0

### Item: Archive: Size of files need to archive
- **Description**: Size of files to archive.
- **Interval**: 0
- **Data Type**: 0

### Item: Count of autovacuum workers
- **Description**: Number of autovacuum workers.
- **Interval**: 1m
- **Data Type**: 0

### Item: Get bgwriter
- **Description**: Collect all metrics from pg_stat_bgwriter:
https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-BGWRITER-VIEW
- **Interval**: 1m
- **Data Type**: 4

### Item: Bgwriter: Buffers allocated per second
- **Description**: Number of buffers allocated per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Bgwriter: Times a backend executed its own fsync per second
- **Description**: Number of times a backend had to execute its own fsync call per second (normally the background writer handles those even when the backend does its own write).
- **Interval**: 0
- **Data Type**: 0

### Item: Bgwriter: Buffers written directly by a backend per second
- **Description**: Number of buffers written directly by a backend per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Buffers written during checkpoints per second
- **Description**: Number of buffers written during checkpoints per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Buffers written by the background writer per second
- **Description**: Number of buffers written by the background writer per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Requested per second
- **Description**: Number of requested checkpoints that have been performed per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Scheduled per second
- **Description**: Number of scheduled checkpoints that have been performed per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Checkpoint sync time per second
- **Description**: Total amount of time per second that has been spent in the portion of checkpoint processing where files are synchronized to disk.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Checkpoint write time per second
- **Description**: Total amount of time per second that has been spent in the portion of checkpoint processing where files are written to disk.
- **Interval**: 0
- **Data Type**: 0

### Item: Bgwriter: Number of bgwriter cleaning scan stopped per second
- **Description**: Number of times the background writer stopped a cleaning scan because it had written too many buffers per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Cache hit ratio, %
- **Description**: Cache hit ratio.
- **Interval**: 1m
- **Data Type**: 0

### Item: Get connections sum
- **Description**: Collect all metrics from pg_stat_activity:
https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-ACTIVITY-VIEW
- **Interval**: 1m
- **Data Type**: 4

### Item: Connections sum: Active
- **Description**: Total number of connections executing a query.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Disabled
- **Description**: Total number of disabled connections.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Fastpath function call
- **Description**: Total number of connections executing a fast-path function.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Idle
- **Description**: Total number of connections waiting for a new client command.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Idle in transaction
- **Description**: Total number of connections in a transaction state but not executing a query.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Idle in transaction (aborted)
- **Description**: Total number of connections in a transaction state but not executing a query, and where one of the statements in the transaction caused an error.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Prepared
- **Description**: Total number of prepared transactions:
https://www.postgresql.org/docs/current/sql-prepare-transaction.html
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Total
- **Description**: Total number of connections.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Total, %
- **Description**: Total number of connections, in percentage.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Waiting
- **Description**: Total number of waiting connections:
https://www.postgresql.org/docs/current/monitoring-stats.html#WAIT-EVENT-TABLE
- **Interval**: 0
- **Data Type**: 3

### Item: Custom queries
- **Description**: Execute custom queries from file *.sql (check for option Plugins.Postgres.CustomQueriesPath at agent configuration).
- **Interval**: 1m
- **Data Type**: 4

### Item: Get dbstat
- **Description**: Collect all metrics from pg_stat_database per database:
https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-DATABASE-VIEW
- **Interval**: 1m
- **Data Type**: 4

### Item: Get dbstat sum
- **Description**: Collect all metrics from pg_stat_database as sums for all databases:
https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-DATABASE-VIEW
- **Interval**: 1m
- **Data Type**: 4

### Item: Dbstat: Blocks read time
- **Description**: Time spent reading data file blocks by backends.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Hit blocks read per second
- **Description**: Number of times per second disk blocks were found already in the buffer cache
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Disk blocks read per second
- **Description**: Number of disk blocks read per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Blocks write time
- **Description**: Time spent writing data file blocks by backends.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Checksum failures per second
- **Description**: Number of data page checksum failures per second detected (or on a shared object), or NULL if data checksums are not enabled. This metric is available since PostgreSQL 12.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Conflicts per second
- **Description**: Number of queries canceled per second due to conflicts with recovery (conflicts occur only on standby servers; see pg_stat_database_conflicts for details).
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Deadlocks per second
- **Description**: Number of deadlocks detected per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Backends connected
- **Description**: Number of connected backends.
- **Interval**: 0
- **Data Type**: 3

### Item: Dbstat: Number temp bytes per second
- **Description**: Total amount of data written per second to temporary files by queries.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Number temp files per second
- **Description**: Number of temporary files created by queries per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Rows deleted per second
- **Description**: Number of rows deleted by queries per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Rows fetched per second
- **Description**: Number of rows fetched by queries per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Rows inserted per second
- **Description**: Number of rows inserted by queries per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Rows returned per second
- **Description**: Number of rows returned by queries per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Rows updated per second
- **Description**: Number of rows updated by queries per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Committed transactions per second
- **Description**: Number of transactions that have been committed per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Dbstat: Roll backed transactions per second
- **Description**: Number of transactions that have been rolled back per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Get locks
- **Description**: Collect all metrics from pg_locks per database:
https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-TABLES
- **Interval**: 1m
- **Data Type**: 4

### Item: Age of oldest xid
- **Description**: Age of oldest xid.
- **Interval**: 1m
- **Data Type**: 0

### Item: Ping
- **Description**: Used to test a connection to see if it is alive. It is set to 0 if the query is unsuccessful.
- **Interval**: 1m
- **Data Type**: 3

### Item: Get queries
- **Description**: Collect all metrics by query execution time.
- **Interval**: 1m
- **Data Type**: 4

### Item: Replication: Standby count
- **Description**: Number of standby servers.
- **Interval**: 1m
- **Data Type**: 3

### Item: Replication: Lag in bytes
- **Description**: Replication lag with master, in bytes.
- **Interval**: 1m
- **Data Type**: 3

### Item: Replication: Lag in seconds
- **Description**: Replication lag with master, in seconds.
- **Interval**: 1m
- **Data Type**: 3

### Item: Get replication
- **Description**: Collect metrics from the pg_stat_replication, which contains information about the WAL sender process, showing statistics about replication to that sender's connected standby server.
- **Interval**: 1m
- **Data Type**: 4

### Item: Replication: Recovery role
- **Description**: Replication role: 1 — recovery is still in progress (standby mode), 0 — master mode.
- **Interval**: 1m
- **Data Type**: 3

### Item: Replication: Status
- **Description**: Replication status: 0 — streaming is down, 1 — streaming is up, 2 — master mode.
- **Interval**: 1m
- **Data Type**: 3

### Item: Uptime
- **Description**: Time since the server started.
- **Interval**: 1m
- **Data Type**: 0

### Item: Version
- **Description**: PostgreSQL version.
- **Interval**: 15m
- **Data Type**: 1

### Item: WAL: Segments count
- **Description**: Number of WAL segments.
- **Interval**: 0
- **Data Type**: 3

### Item: WAL: Bytes received
- **Description**: WAL receive, in bytes.
- **Interval**: 0
- **Data Type**: 3

### Item: Get WAL
- **Description**: Collect write-ahead log (WAL) metrics.
- **Interval**: 5m
- **Data Type**: 4

### Item: WAL: Bytes written
- **Description**: WAL write, in bytes.
- **Interval**: 0
- **Data Type**: 3

