# CockroachDB by HTTP template description

The template to monitor CockroachDB nodes by Zabbix that works without any external scripts.
Most of the metrics are collected in one go, thanks to Zabbix bulk data collection.

The template collects metrics by HTTP agent from Prometheus endpoint and health endpoints.

Internal node metrics are collected from Prometheus /_status/vars endpoint.
Node health metrics are collected from /health and /health?ready=1 endpoints.
The template doesn't require usage of session token.

Note, that some metrics may not be collected depending on your CockroachDB version and configuration.

Setup:

Set the hostname or IP address of the CockroachDB node host in the '{$COCKROACHDB.API.HOST}' macro. You can also change the port in the '{$COCKROACHDB.API.PORT}' macro and the scheme in the '{$COCKROACHDB.API.SCHEME}' macro if necessary.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Storage metrics discovery ](#discovery_storage_metrics_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| CA certificate expiration date | CA certificate expires at that date. | cockroachdb.cert.expire_date.ca | DEPENDENT | 0 |
| Node certificate expiration date | Node certificate expires at that date. | cockroachdb.cert.expire_date.node | DEPENDENT | 0 |
| Clock offset | Mean clock offset of the node against the rest of the cluster. | cockroachdb.clock.offset | DEPENDENT | 0 |
| CPU: System time | System CPU time. | cockroachdb.cpu.system_time | DEPENDENT | 0 |
| CPU: User time | User CPU time. | cockroachdb.cpu.user_time | DEPENDENT | 0 |
| CPU: Utilization | The CPU utilization expressed in %. | cockroachdb.cpu.util | DEPENDENT | 0 |
| File descriptors: Limit | Open file descriptors soft limit of the process. | cockroachdb.descriptors.limit | DEPENDENT | 0 |
| File descriptors: Open | The number of open file descriptors. | cockroachdb.descriptors.open | DEPENDENT | 0 |
| Disk: IOPS in progress, rate | Number of disk IO operations currently in progress on this host. | cockroachdb.disk.iops.in_progress.rate | DEPENDENT | 0 |
| Disk: Read IOPS, rate | Number of disk read operations per second across all disks since this process started. | cockroachdb.disk.iops.read.rate | DEPENDENT | 0 |
| Disk: Write IOPS, rate | Disk write operations per second across all disks since this process started. | cockroachdb.disk.iops.write.rate | DEPENDENT | 0 |
| Disk: Reads, rate | Bytes read from all disks per second since this process started | cockroachdb.disk.read.rate | DEPENDENT | 0 |
| Disk: Writes, rate | Bytes written to all disks per second since this process started. | cockroachdb.disk.write.rate | DEPENDENT | 0 |
| GC: Pause time | The amount of processor time used by Go's garbage collector across all nodes. During garbage collection, application code execution is paused. | cockroachdb.gc.pause_time | DEPENDENT | 0 |
| GC: Runs, rate | The number of times that Go's garbage collector was invoked per second across all nodes. | cockroachdb.gc.runs.rate | DEPENDENT | 0 |
| Get health | Get node /health endpoint | cockroachdb.get_health | HTTP_AGENT | no delay |
| Get metrics | Get raw metrics from the Prometheus endpoint. | cockroachdb.get_metrics | HTTP_AGENT | no delay |
| Get readiness | Get node /health?ready=1 endpoint | cockroachdb.get_readiness | HTTP_AGENT | no delay |
| Go: Goroutines count | Current number of Goroutines. This count should rise and fall based on load. | cockroachdb.go.goroutines.count | DEPENDENT | 0 |
| Liveness heartbeats, rate | Number of successful node liveness heartbeats per second from this node. | cockroachdb.heartbeaths.success.rate | DEPENDENT | 0 |
| KV transactions: Aborted, rate | Number of aborted KV transactions per second. | cockroachdb.kv.transactions.aborted.rate | DEPENDENT | 0 |
| KV transactions: Committed, rate | Number of KV transactions (including 1PC) committed per second. | cockroachdb.kv.transactions.committed.rate | DEPENDENT | 0 |
| Live nodes count | The number of live nodes in the cluster (will be 0 if this node is not itself live). | cockroachdb.live_count | DEPENDENT | 0 |
| Memory: Allocated by Cgo | Current bytes of memory allocated by the C layer. | cockroachdb.memory.cgo.allocated | DEPENDENT | 0 |
| Memory: Managed by Cgo | Total bytes of memory managed by the C layer. | cockroachdb.memory.cgo.managed | DEPENDENT | 0 |
| Memory: Allocated by Go | Current bytes of memory allocated by the Go layer. | cockroachdb.memory.go.allocated | DEPENDENT | 0 |
| Memory: Managed by Go | Total bytes of memory managed by the Go layer. | cockroachdb.memory.go.managed | DEPENDENT | 0 |
| Memory: Allocated by SQL | Current SQL statement memory usage for root. | cockroachdb.memory.sql | DEPENDENT | 0 |
| Memory: Total usage | Resident set size (RSS) of memory in use by the node. | cockroachdb.memory.total | DEPENDENT | 0 |
| Network: Bytes received, rate | Bytes received per second on all network interfaces since this process started. | cockroachdb.network.bytes.received.rate | DEPENDENT | 0 |
| Network: Bytes sent, rate | Bytes sent per second on all network interfaces since this process started. | cockroachdb.network.bytes.sent.rate | DEPENDENT | 0 |
| Slow requests: DistSender RPCs | Number of RPCs stuck or retrying for a long time. | cockroachdb.slow_requests.rpc | DEPENDENT | 0 |
| SQL: Bytes received, rate | Total amount of incoming SQL client network traffic in bytes per second. | cockroachdb.sql.bytes.received.rate | DEPENDENT | 0 |
| SQL: Bytes sent, rate | Total amount of outgoing SQL client network traffic in bytes per second. | cockroachdb.sql.bytes.sent.rate | DEPENDENT | 0 |
| SQL: Schema changes, rate | Total number of SQL DDL statements successfully executed per second. | cockroachdb.sql.schema_changes.rate | DEPENDENT | 0 |
| SQL sessions: Open | Total number of open SQL sessions. | cockroachdb.sql.sessions | DEPENDENT | 0 |
| SQL statements: Active | Total number of SQL statements currently active. | cockroachdb.sql.statements.active | DEPENDENT | 0 |
| SQL statements: Contention, rate | Total number of SQL statements that experienced contention per second. | cockroachdb.sql.statements.contention.rate | DEPENDENT | 0 |
| SQL statements: DELETE, rate | A moving average of the number of DELETE statements successfully executed per second. | cockroachdb.sql.statements.delete.rate | DEPENDENT | 0 |
| SQL statements: Denials, rate | The number of statements denied per second by a feature flag. | cockroachdb.sql.statements.denials.rate | DEPENDENT | 0 |
| SQL statements: Errors, rate | Total number of statements which returned a planning or runtime error per second. | cockroachdb.sql.statements.errors.rate | DEPENDENT | 0 |
| SQL statements: Executed, rate | Number of SQL queries executed per second. | cockroachdb.sql.statements.executed.rate | DEPENDENT | 0 |
| SQL statements: Active flows distributed, rate | The number of distributed SQL flows currently active per second. | cockroachdb.sql.statements.flows.active.rate | DEPENDENT | 0 |
| SQL statements: INSERT, rate | A moving average of the number of INSERT statements successfully executed per second. | cockroachdb.sql.statements.insert.rate | DEPENDENT | 0 |
| SQL statements: SELECT, rate | A moving average of the number of SELECT statements successfully executed per second. | cockroachdb.sql.statements.select.rate | DEPENDENT | 0 |
| SQL statements: UPDATE, rate | A moving average of the number of UPDATE statements successfully executed per second. | cockroachdb.sql.statements.update.rate | DEPENDENT | 0 |
| SQL transactions: Aborted, rate | Total number of SQL transaction abort errors per second. | cockroachdb.sql.transactions.aborted.rate | DEPENDENT | 0 |
| SQL transactions: Committed, rate | Total number of SQL transaction COMMIT statements successfully executed per second. | cockroachdb.sql.transactions.committed.rate | DEPENDENT | 0 |
| SQL transactions: Initiated, rate | Total number of SQL transaction BEGIN statements successfully executed per second. | cockroachdb.sql.transactions.initiated.rate | DEPENDENT | 0 |
| SQL transactions: Open | Total number of currently open SQL transactions. | cockroachdb.sql.transactions.open | DEPENDENT | 0 |
| SQL transactions: Rolled back, rate | Total number of SQL transaction ROLLBACK statements successfully executed per second. | cockroachdb.sql.transactions.rollbacks.rate | DEPENDENT | 0 |
| Time series: Sample errors, rate | The number of errors encountered while attempting to write metrics to disk, per second. | cockroachdb.ts.samples.errors.rate | DEPENDENT | 0 |
| Time series: Samples written, rate | The number of successfully written metric samples per second. | cockroachdb.ts.samples.written.rate | DEPENDENT | 0 |
| Uptime | Process uptime. | cockroachdb.uptime | DEPENDENT | 0 |
| Version | Build information. | cockroachdb.version | DEPENDENT | 0 |
| Service ping | Check if HTTP/HTTPS service accepts TCP connections. | net.tcp.service["{$COCKROACHDB.API.SCHEME}","{$COCKROACHDB.API.HOST}","{$COCKROACHDB.API.PORT}"] | SIMPLE | no delay |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$COCKROACHDB.API.HOST} | <SET COCKROACHDB HOST> |
| {$COCKROACHDB.API.PORT} | 8080 |
| {$COCKROACHDB.API.SCHEME} | http |
| {$COCKROACHDB.CERT.CA.EXPIRY.WARN} | 90 |
| {$COCKROACHDB.CERT.NODE.EXPIRY.WARN} | 30 |
| {$COCKROACHDB.CLOCK.OFFSET.MAX.WARN} | 300 |
| {$COCKROACHDB.OPEN.FDS.MAX.WARN} | 80 |
| {$COCKROACHDB.STATEMENTS.ERRORS.MAX.WARN} | 2 |
| {$COCKROACHDB.STORE.USED.MIN.CRIT} | 10 |
| {$COCKROACHDB.STORE.USED.MIN.WARN} | 20 |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| CA certificate expires soon | WARNING | CA certificate expires soon. | (last(/CockroachDB by HTTP/cockroachdb.cert.expire_date.ca) - now()) / 86400 < {$COCKROACHDB.CERT.CA.EXPIRY.WARN} | [{"tag": "scope", "value": "notice"}] | no url |
| Node certificate expires soon | WARNING | Node certificate expires soon. | (last(/CockroachDB by HTTP/cockroachdb.cert.expire_date.node) - now()) / 86400 < {$COCKROACHDB.CERT.NODE.EXPIRY.WARN} | [{"tag": "scope", "value": "notice"}] | no url |
| Clock offset is too high | WARNING | Cockroach-measured clock offset is nearing limit (by default, servers kill themselves at 400ms from the mean). | min(/CockroachDB by HTTP/cockroachdb.clock.offset,5m) > {$COCKROACHDB.CLOCK.OFFSET.MAX.WARN} * 0.001 | [{"tag": "scope", "value": "health"}] | no url |
| Node is unhealthy | AVERAGE | Node's /health endpoint has returned HTTP 500 Internal Server Error which indicates unhealthy mode. | last(/CockroachDB by HTTP/cockroachdb.get_health) = 500 | [{"tag": "scope", "value": "health"}] | no url |
| SQL statements errors rate is too high | WARNING | no description | min(/CockroachDB by HTTP/cockroachdb.sql.statements.errors.rate,5m) > {$COCKROACHDB.STATEMENTS.ERRORS.MAX.WARN} | [{"tag": "scope", "value": "health"}] | no url |
| Failed to fetch node data | WARNING | Zabbix has not received data for items for the last 5 minutes. | nodata(/CockroachDB by HTTP/cockroachdb.uptime,5m) = 1 | [{"tag": "scope", "value": "availability"}] | no url |
| Node has been restarted | INFO | Uptime is less than 10 minutes. | last(/CockroachDB by HTTP/cockroachdb.uptime) < 10m | [{"tag": "scope", "value": "notice"}] | no url |
| Version has changed | INFO | no description | last(/CockroachDB by HTTP/cockroachdb.version) <> last(/CockroachDB by HTTP/cockroachdb.version,#2) and length(last(/CockroachDB by HTTP/cockroachdb.version)) > 0 | [{"tag": "scope", "value": "notice"}] | no url |
| Service is down | AVERAGE | no description | last(/CockroachDB by HTTP/net.tcp.service["{$COCKROACHDB.API.SCHEME}","{$COCKROACHDB.API.HOST}","{$COCKROACHDB.API.PORT}"]) = 0 | [{"tag": "scope", "value": "availability"}] | no url |
| Current number of open files is too high | WARNING | Getting close to open file descriptor limit. | min(/CockroachDB by HTTP/cockroachdb.descriptors.open,10m) / last(/CockroachDB by HTTP/cockroachdb.descriptors.limit) * 100 > {$COCKROACHDB.OPEN.FDS.MAX.WARN} | no tags | no url |
| Node is not executing SQL | WARNING | Node is not executing SQL despite having connections. | last(/CockroachDB by HTTP/cockroachdb.sql.sessions) > 0 and last(/CockroachDB by HTTP/cockroachdb.sql.statements.executed.rate) = 0 | [{"tag": "scope", "value": "notice"}] | no url |
| Node is not ready | AVERAGE | Node's /health?ready=1 endpoint has returned HTTP 503 Service Unavailable. Possible reasons:<br>- node is in the wait phase of the node shutdown sequence;<br>- node is unable to communicate with a majority of the other nodes in the cluster, likely because the cluster is unavailable due to too many nodes being down. | last(/CockroachDB by HTTP/cockroachdb.get_readiness) = 503 and last(/CockroachDB by HTTP/cockroachdb.uptime) > 5m | [{"tag": "scope", "value": "health"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Storage metrics discovery | cockroachdb.store.discovery | Discover per store metrics. | DEPENDENT | no lifetime | 0 |


<a name="discovery_storage_metrics_discovery"></a>

## Discovery Storage metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Storage [{#STORE}]: Queue processing failures: Consistency, rate | Number of replicas which failed processing in the consistency checker queue per second. | cockroachdb.queue.processing_failures.consistency.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Queue processing failures: GC, rate | Number of replicas which failed processing in the GC queue per second. | cockroachdb.queue.processing_failures.gc.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Queue processing failures: Replica GC, rate | Number of replicas which failed processing in the replica GC queue per second. | cockroachdb.queue.processing_failures.gc_replica.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Queue processing failures: Raft log, rate | Number of replicas which failed processing in the Raft log queue per second. | cockroachdb.queue.processing_failures.raftlog.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Queue processing failures: Raft snapshot, rate | Number of replicas which failed processing in the Raft repair queue per second. | cockroachdb.queue.processing_failures.raftsnapshot.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Queue processing failures: Replicate, rate | Number of replicas which failed processing in the replicate queue per second. | cockroachdb.queue.processing_failures.replicate.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Queue processing failures: Split, rate | Number of replicas which failed processing in the split queue per second. | cockroachdb.queue.processing_failures.split.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Queue processing failures: Time series maintenance, rate | Number of replicas which failed processing in the time series maintenance queue per second. | cockroachdb.queue.processing_failures.tsmaintenance.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Ranges count | Number of ranges. | cockroachdb.ranges.[{#STORE},count] | DEPENDENT |
| Storage [{#STORE}]: Ranges unavailable | Number of ranges with fewer live replicas than needed for quorum. | cockroachdb.ranges.[{#STORE},unavailable] | DEPENDENT |
| Storage [{#STORE}]: Ranges underreplicated | Number of ranges with fewer live replicas than the replication target. | cockroachdb.ranges.[{#STORE},underreplicated] | DEPENDENT |
| Storage [{#STORE}]: Rebalancing: Average queries, rate | Number of kv-level requests received per second by the store, averaged over a large time period as used in rebalancing decisions. | cockroachdb.rebalancing.queries.average.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Rebalancing: Average writes, rate | Number of keys written (i.e. applied by raft) per second to the store, averaged over a large time period as used in rebalancing decisions. | cockroachdb.rebalancing.writes.average.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: Replication: Replicas | Number of replicas. | cockroachdb.replication.replicas.[{#STORE},count] | DEPENDENT |
| Storage [{#STORE}]: Replication: Replicas quiesced | Number of quiesced replicas. | cockroachdb.replication.replicas.[{#STORE},quiesced] | DEPENDENT |
| Storage [{#STORE}]: Replication: Lease holders | Number of lease holders. | cockroachdb.replication.[{#STORE},lease_holders] | DEPENDENT |
| Storage [{#STORE}]: RocksDB cache hits, rate | Count of block cache hits per second. | cockroachdb.rocksdb.cache.hits.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: RocksDB cache misses, rate | Count of block cache misses per second. | cockroachdb.rocksdb.cache.misses.[{#STORE},rate] | DEPENDENT |
| Storage [{#STORE}]: RocksDB cache hit ratio | Block cache hit ratio in %. | cockroachdb.rocksdb.cache.[{#STORE},hit_ratio] | CALCULATED |
| Storage [{#STORE}]: RocksDB read amplification | The average number of real read operations executed per logical read operation. | cockroachdb.rocksdb.[{#STORE},read_amp] | DEPENDENT |
| Storage [{#STORE}]: RocksDB SSTables | The number of SSTables in use. | cockroachdb.rocksdb.[{#STORE},sstables] | DEPENDENT |
| Storage [{#STORE}]: Slow requests: Latch acquisitions | Number of requests that have been stuck for a long time acquiring latches. | cockroachdb.slow_requests.[{#STORE},latch_acquisitions] | DEPENDENT |
| Storage [{#STORE}]: Slow requests: Lease acquisitions | Number of requests that have been stuck for a long time acquiring a lease. | cockroachdb.slow_requests.[{#STORE},lease_acquisitions] | DEPENDENT |
| Storage [{#STORE}]: Slow requests: Raft proposals | Number of requests that have been stuck for a long time in raft. | cockroachdb.slow_requests.[{#STORE},raft_proposals] | DEPENDENT |
| Storage [{#STORE}]: Bytes: Live | Number of logical bytes stored in live key-value pairs on this node. Live data excludes historical and deleted data. | cockroachdb.storage.bytes.[{#STORE},live] | DEPENDENT |
| Storage [{#STORE}]: Bytes: Logical | Number of logical bytes stored in key-value pairs on this node. This includes historical and deleted data. | cockroachdb.storage.bytes.[{#STORE},logical] | DEPENDENT |
| Storage [{#STORE}]: Bytes: System | Number of physical bytes stored in system key-value pairs. | cockroachdb.storage.bytes.[{#STORE},system] | DEPENDENT |
| Storage [{#STORE}]: Capacity available | Available storage capacity. | cockroachdb.storage.capacity.[{#STORE},available] | DEPENDENT |
| Storage [{#STORE}]: Capacity available in % | Available storage capacity in %. | cockroachdb.storage.capacity.[{#STORE},available_percent] | CALCULATED |
| Storage [{#STORE}]: Capacity total | Total storage capacity. This value may be explicitly set using --store. If a store size has not been set, this metric displays the actual disk capacity. | cockroachdb.storage.capacity.[{#STORE},total] | DEPENDENT |
| Storage [{#STORE}]: Capacity used | Disk space in use by CockroachDB data on this node. This excludes the Cockroach binary, operating system, and other system files. | cockroachdb.storage.capacity.[{#STORE},used] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Storage [{#STORE}]: Available storage capacity is critically low | AVERAGE | Storage is running critically low on free space (less than {$COCKROACHDB.STORE.USED.MIN.CRIT}% available). | max(/CockroachDB by HTTP/cockroachdb.storage.capacity.[{#STORE},available_percent],5m) < {$COCKROACHDB.STORE.USED.MIN.CRIT} | [{"tag": "scope", "value": "capacity"}] | no url |
| Storage [{#STORE}]: Available storage capacity is low | WARNING | Storage is running low on free space (less than {$COCKROACHDB.STORE.USED.MIN.WARN}% available). | max(/CockroachDB by HTTP/cockroachdb.storage.capacity.[{#STORE},available_percent],5m) < {$COCKROACHDB.STORE.USED.MIN.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |

