# Kubernetes API server by HTTP template description

Get Kubernetes API server metrics by HTTP agent from Prometheus metrics endpoint.

Don't forget change macros {$KUBE.API.SERVER.URL}, {$KUBE.API.TOKEN}.
Some metrics may not be collected depending on your Kubernetes API server instance version and configuration.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Watchers metrics discovery ](#discovery_watchers_metrics_discovery)
  * [Discovery Authentication requests discovery ](#discovery_authentication_requests_discovery)
  * [Discovery Authentication attempts discovery ](#discovery_authentication_attempts_discovery)
  * [Discovery Client certificate expiration histogram ](#discovery_client_certificate_expiration_histogram)
  * [Discovery Etcd objects metrics discovery ](#discovery_etcd_objects_metrics_discovery)
  * [Discovery gRPC completed requests discovery ](#discovery_grpc_completed_requests_discovery)
  * [Discovery Requests inflight discovery ](#discovery_requests_inflight_discovery)
  * [Discovery Long-running requests ](#discovery_long-running_requests)
  * [Discovery Request duration histogram ](#discovery_request_duration_histogram)
  * [Discovery Workqueue metrics discovery ](#discovery_workqueue_metrics_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| Request terminations, rate | Number of requests which apiserver terminated in self-defense per second. | kubernetes.api.apiserver_request_terminations | DEPENDENT | 0 |
| API server requests: 0 | Counter of apiserver requests broken out for each HTTP response code. | kubernetes.api.apiserver_request_total_0.rate | DEPENDENT | 0 |
| API server requests: 2xx, rate | Counter of apiserver requests broken out for each HTTP response code. | kubernetes.api.apiserver_request_total_200.rate | DEPENDENT | 0 |
| API server requests: 3xx, rate | Counter of apiserver requests broken out for each HTTP response code. | kubernetes.api.apiserver_request_total_300.rate | DEPENDENT | 0 |
| API server requests: 4xx, rate | Counter of apiserver requests broken out for each HTTP response code. | kubernetes.api.apiserver_request_total_400.rate | DEPENDENT | 0 |
| API server requests: 5xx, rate | Counter of apiserver requests broken out for each HTTP response code. | kubernetes.api.apiserver_request_total_500.rate | DEPENDENT | 0 |
| TLS handshake errors, rate | Number of requests dropped with 'TLS handshake error from' error per second. | kubernetes.api.apiserver_tls_handshake_errors_total.rate | DEPENDENT | 0 |
| Audit events, total | Accumulated number audit events generated and sent to the audit backend. | kubernetes.api.audit_event_total | DEPENDENT | 0 |
| CPU | Total user and system CPU usage ratio. | kubernetes.api.cpu.util | DEPENDENT | 0 |
| Get API instance metrics | Get raw metrics from API instance /metrics endpoint. | kubernetes.api.get_metrics | HTTP_AGENT | no delay |
| Goroutines | Number of goroutines that currently exist. | kubernetes.api.go_goroutines | DEPENDENT | 0 |
| Go threads | Number of OS threads created. | kubernetes.api.go_threads | DEPENDENT | 0 |
| gRPCs messages received, rate | Total number of gRPC stream messages received per second. | kubernetes.api.grpc_client_msg_received.rate | DEPENDENT | 0 |
| gRPCs messages sent, rate | Total number of gRPC stream messages sent per second. | kubernetes.api.grpc_client_msg_sent.rate | DEPENDENT | 0 |
| gRPCs client started, rate | Total number of RPCs started per second. | kubernetes.api.grpc_client_started.rate | DEPENDENT | 0 |
| Fds max | Maximum allowed open file descriptors. | kubernetes.api.max_fds | DEPENDENT | 0 |
| Fds open | Number of open file descriptors. | kubernetes.api.open_fds | DEPENDENT | 0 |
| Resident memory, bytes | Resident memory size in bytes. | kubernetes.api.process_resident_memory_bytes | DEPENDENT | 0 |
| Virtual memory, bytes | Virtual memory size in bytes. | kubernetes.api.process_virtual_memory_bytes | DEPENDENT | 0 |
| HTTP requests: 2xx, rate | Number of HTTP requests with 2xx status code per second. | kubernetes.api.rest_client_requests_total_200.rate | DEPENDENT | 0 |
| HTTP requests: 3xx, rate | Number of HTTP requests with 3xx status code per second. | kubernetes.api.rest_client_requests_total_300.rate | DEPENDENT | 0 |
| HTTP requests: 4xx, rate | Number of HTTP requests with 4xx status code per second. | kubernetes.api.rest_client_requests_total_400.rate | DEPENDENT | 0 |
| HTTP requests: 5xx, rate | Number of HTTP requests with 5xx status code per second. | kubernetes.api.rest_client_requests_total_500.rate | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$KUBE.API.CERT.EXPIRATION} | 7 |
| {$KUBE.API.HTTP.CLIENT.ERROR} | 2 |
| {$KUBE.API.HTTP.SERVER.ERROR} | 2 |
| {$KUBE.API.SERVER.URL} | https://localhost:6443/metrics |
| {$KUBE.API.TOKEN} | no value |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Too many server errors | WARNING | "Kubernetes API server is experiencing high error rate (with 5xx HTTP code). | min(/Kubernetes API server by HTTP/kubernetes.api.apiserver_request_total_500.rate,5m)>{$KUBE.API.HTTP.SERVER.ERROR} | [{"tag": "scope", "value": "availability"}] | no url |
| Too many client errors | WARNING | "Kubernetes API client is experiencing high error rate (with 5xx HTTP code). | min(/Kubernetes API server by HTTP/kubernetes.api.rest_client_requests_total_500.rate,5m)>{$KUBE.API.HTTP.CLIENT.ERROR} | [{"tag": "scope", "value": "availability"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Watchers metrics discovery | kubernetes.api.apiserver_registered_watchers.discovery | Discovery watchers by kind. | DEPENDENT | no lifetime | 0 |
| Authentication requests discovery | kubernetes.api.authenticated_user_requests.discovery | Discovery authentication attempts by name. | DEPENDENT | no lifetime | 0 |
| Authentication attempts discovery | kubernetes.api.authentication_attempts.discovery | Discovery authentication attempts by result. | DEPENDENT | no lifetime | 0 |
| Client certificate expiration histogram | kubernetes.api.certificate_expiration.discovery | Discovery raw data of client certificate expiration | DEPENDENT | no lifetime | 0 |
| Etcd objects metrics discovery | kubernetes.api.etcd_object_counts.discovery | Discovery etcd objects by resource. | DEPENDENT | no lifetime | 0 |
| gRPC completed requests discovery | kubernetes.api.grpc_client_handled.discovery | Discovery grpc completed requests by grpc code. | DEPENDENT | no lifetime | 0 |
| Requests inflight discovery | kubernetes.api.inflight_requests.discovery | Discovery requests inflight by kind. | DEPENDENT | no lifetime | 0 |
| Long-running requests | kubernetes.api.longrunning_gauge.discovery | Discovery of long-running requests by verb, resource and scope. | DEPENDENT | no lifetime | 0 |
| Request duration histogram | kubernetes.api.requests_bucket.discovery | Discovery raw data and percentile items of request duration. | DEPENDENT | no lifetime | 0 |
| Workqueue metrics discovery | kubernetes.api.workqueue.discovery | Discovery workqueue metrics by name. | DEPENDENT | no lifetime | 0 |


<a name="discovery_watchers_metrics_discovery"></a>

## Discovery Watchers metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Watchers: {#KIND} | Number of currently registered watchers for a given resource. | kubernetes.api.apiserver_registered_watchers["{#KIND}"] | DEPENDENT |


<a name="discovery_authentication_requests_discovery"></a>

## Discovery Authentication requests discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Authenticated requests: {#NAME}, rate | Counter of authenticated requests broken out by username per second. | kubernetes.api.authenticated_user_requests.rate["{#NAME}"] | DEPENDENT |


<a name="discovery_authentication_attempts_discovery"></a>

## Discovery Authentication attempts discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Authentication attempts: {#RESULT}, rate | Authentication attempts by result per second. | kubernetes.api.authentication_attempts.rate["{#RESULT}"] | DEPENDENT |


<a name="discovery_client_certificate_expiration_histogram"></a>

## Discovery Client certificate expiration histogram

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Client certificate expiration, p1 | 1 percentile of the remaining lifetime on the certificate used to authenticate a request. | kubernetes.api.client_certificate_expiration_p1[{#SINGLETON}] | CALCULATED |
| Certificate expiration seconds bucket, {#LE} | Distribution of the remaining lifetime on the certificate used to authenticate a request. | kubernetes.api.client_certificate_expiration_seconds_bucket[{#LE}] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Kubernetes client certificate expires soon | WARNING | A client certificate used to authenticate to the apiserver is expiring in less than 24.0 hours. | last(/Kubernetes API server by HTTP/kubernetes.api.client_certificate_expiration_p1[{#SINGLETON}]) > 0 and last(/Kubernetes API server by HTTP/kubernetes.api.client_certificate_expiration_p1[{#SINGLETON}]) < 24*60*60 | [{"tag": "scope", "value": "availability"}] | no url |
| Kubernetes client certificate is expiring | WARNING | A client certificate used to authenticate to the apiserver is expiring in {$KUBE.API.CERT.EXPIRATION} days. | last(/Kubernetes API server by HTTP/kubernetes.api.client_certificate_expiration_p1[{#SINGLETON}]) > 0 and last(/Kubernetes API server by HTTP/kubernetes.api.client_certificate_expiration_p1[{#SINGLETON}]) < {$KUBE.API.CERT.EXPIRATION}*24*60*60 | [{"tag": "scope", "value": "availability"}] | no url |


<a name="discovery_etcd_objects_metrics_discovery"></a>

## Discovery Etcd objects metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| etcd objects: {#RESOURCE} | Number of stored objects at the time of last check split by kind. | kubernetes.api.etcd_object_counts["{#RESOURCE}"] | DEPENDENT |


<a name="discovery_grpc_completed_requests_discovery"></a>

## Discovery gRPC completed requests discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| gRPCs completed: {#GRPC_CODE}, rate | Total number of RPCs completed by the client regardless of success or failure per second. | kubernetes.api.grpc_client_handled_total.rate["{#GRPC_CODE}"] | DEPENDENT |


<a name="discovery_requests_inflight_discovery"></a>

## Discovery Requests inflight discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Requests current: {#KIND} | Maximal number of currently used inflight request limit of this apiserver per request kind in last second. | kubernetes.api.current_inflight_requests["{#KIND}"] | DEPENDENT |


<a name="discovery_long-running_requests"></a>

## Discovery Long-running requests

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Long-running ["{#VERB}"] requests ["{#RESOURCE}"]: {#SCOPE} | Gauge of all active long-running apiserver requests broken out by verb, resource and scope. Not all requests are tracked this way. | kubernetes.api.longrunning_gauge["{#RESOURCE}","{#SCOPE}","{#VERB}"] | DEPENDENT |


<a name="discovery_request_duration_histogram"></a>

## Discovery Request duration histogram

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| ["{#VERB}"] Requests bucket: {#LE} | Response latency distribution in seconds for each verb. | kubernetes.api.request_duration_seconds_bucket[{#LE},"{#VERB}"] | DEPENDENT |
| ["{#VERB}"] Requests, p50 | 50 percentile of response latency distribution in seconds for each verb. | kubernetes.api.request_duration_seconds_p50["{#VERB}"] | CALCULATED |
| ["{#VERB}"] Requests, p90 | 90 percentile of response latency distribution in seconds for each verb. | kubernetes.api.request_duration_seconds_p90["{#VERB}"] | CALCULATED |
| ["{#VERB}"] Requests, p95 | 95 percentile of response latency distribution in seconds for each verb. | kubernetes.api.request_duration_seconds_p95["{#VERB}"] | CALCULATED |
| ["{#VERB}"] Requests, p99 | 99 percentile of response latency distribution in seconds for each verb. | kubernetes.api.request_duration_seconds_p99["{#VERB}"] | CALCULATED |


<a name="discovery_workqueue_metrics_discovery"></a>

## Discovery Workqueue metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| ["{#NAME}"] Workqueue adds total, rate | Total number of adds handled by workqueue per second. | kubernetes.api.workqueue_adds_total.rate["{#NAME}"] | DEPENDENT |
| ["{#NAME}"] Workqueue depth | Current depth of workqueue. | kubernetes.api.workqueue_depth["{#NAME}"] | DEPENDENT |

