# Template: PostgreSQL by Zabbix agent

## Template ID
10357

## Description
This template is designed for the deployment of PostgreSQL monitoring by Zabbix via Zabbix agent and uses user parameters to run SQL queries with the `psql` command-line tool.

Note:
- The template requires `pg_isready` and `psql` utilities to be installed on the same host with Zabbix agent.
- The template requires files with SQL queries and user parameters that can be found in the Zabbix official repository:
https://git.zabbix.com/projects/ZBX/repos/zabbix/browse/templates/db/postgresql?at=refs%2Fheads%2Frelease%2F6.0

Setup:

1. Deploy Zabbix agent and create the PostgreSQL user for monitoring (`<password>` at your discretion) with proper access rights to your PostgreSQL instance.

For PostgreSQL version 10 and above:
CREATE USER zbx_monitor WITH PASSWORD '<PASSWORD>' INHERIT;
GRANT pg_monitor TO zbx_monitor;

For PostgreSQL version 9.6 and below:
CREATE USER zbx_monitor WITH PASSWORD '<PASSWORD>';
GRANT SELECT ON pg_stat_database TO zbx_monitor;
ALTER USER zbx_monitor WITH SUPERUSER;

2. Copy the `postgresql/` directory to the `zabbix` user home directory - `/var/lib/zabbix/`. The `postgresql/` directory contains the files with SQL queries needed to obtain metrics from PostgreSQL instance.

If the home directory of the `zabbix` user doesn't exist, create it first:
mkdir -m u=rwx,g=rwx,o= -p /var/lib/zabbix
chown zabbix:zabbix /var/lib/zabbix

3. Copy the `template_db_postgresql.conf` file, containing user parameters, to the Zabbix agent configuration directory `/etc/zabbix/zabbix_agentd.d/` and restart Zabbix agent service.

If you want to use SSL/TLS encryption to protect communications with the remote PostgreSQL instance, you can modify the connection string in user parameters. For example, to enable required encryption in transport mode without identity checks you could append `?sslmode=required` to the end of the connection string for all keys that use `psql`:
UserParameter=pgsql.bgwriter[*], psql -qtAX postgresql://"$3":"$4"@"$1":"$2"/"$5"?sslmode=required -f "/var/lib/zabbix/postgresql/pgsql.bgwriter.sql"

Consult the PostgreSQL documentation about protection modes (https://www.postgresql.org/docs/current/libpq-ssl.html#LIBPQ-SSL-PROTECTION) and client connection parameters (https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNECT-SSLMODE).

Also, it is assumed that you set up the PostgreSQL instance to work in the desired encryption mode. Check the PostgreSQL documentation (https://www.postgresql.org/docs/current/ssl-tcp.html) for details.

4. Edit the `pg_hba.conf` configuration file to allow connections for the user `zbx_monitor`. You can check the PostgreSQL documentation for examples (https://www.postgresql.org/docs/current/auth-pg-hba-conf.html).

5. Specify the host name or IP address in the `{$PG.HOST}` macro. Adjust the port number with `{$PG.PORT}` macro if needed.

6. Set the password that you specified in step 1 in the macro `{$PG.PASSWORD}`.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback/384190-%C2%A0discussion-thread-for-official-zabbix-template-db-postgresql

Generated by official Zabbix template tool "Templator"

## Linked Hosts
None

## Items

### Item: Get bgwriter
- **Description**: Collect all metrics from pg_stat_bgwriter:
https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-BGWRITER-VIEW
- **Interval**: 1m
- **Data Type**: 4

### Item: Bgwriter: Buffers allocated per second
- **Description**: Number of buffers allocated per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Bgwriter: Times a backend executed its own fsync per second
- **Description**: Number of times a backend had to execute its own fsync call per second (normally the background writer handles those even when the backend does its own write).
- **Interval**: 0
- **Data Type**: 0

### Item: Bgwriter: Buffers written directly by a backend per second
- **Description**: Number of buffers written directly by a backend per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Buffers written during checkpoints per second
- **Description**: Number of buffers written during checkpoints per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Buffers written by the background writer per second
- **Description**: Number of buffers written by the background writer per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Requested per second
- **Description**: Number of requested checkpoints that have been performed per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Scheduled per second
- **Description**: Number of scheduled checkpoints that have been performed per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Checkpoint sync time per second
- **Description**: Total amount of time per second that has been spent in the portion of checkpoint processing where files are synchronized to disk.
- **Interval**: 0
- **Data Type**: 0

### Item: Checkpoint: Checkpoint write time per second
- **Description**: Total amount of time per second that has been spent in the portion of checkpoint processing where files are written to disk.
- **Interval**: 0
- **Data Type**: 0

### Item: Bgwriter: Number of bgwriter cleaning scan stopped per second
- **Description**: Number of times the background writer stopped a cleaning scan because it had written too many buffers per second.
- **Interval**: 0
- **Data Type**: 0

### Item: Cache hit ratio, %
- **Description**: Cache hit ratio.
- **Interval**: 1m
- **Data Type**: 0

### Item: Config hash
- **Description**: PostgreSQL configuration hash.
- **Interval**: 15m
- **Data Type**: 4

### Item: Get connections sum
- **Description**: Collect all metrics from pg_stat_activity:
https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-ACTIVITY-VIEW
- **Interval**: 1m
- **Data Type**: 4

### Item: Connections sum: Active
- **Description**: Total number of connections executing a query.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Idle
- **Description**: Total number of connections waiting for a new client command.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Idle in transaction
- **Description**: Total number of connections in a transaction state but not executing a query.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Prepared
- **Description**: Total number of prepared transactions:
https://www.postgresql.org/docs/current/sql-prepare-transaction.html
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Total
- **Description**: Total number of connections.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Total, %
- **Description**: Total number of connections, in percentage.
- **Interval**: 0
- **Data Type**: 3

### Item: Connections sum: Waiting
- **Description**: Total number of waiting connections:
https://www.postgresql.org/docs/current/monitoring-stats.html#WAIT-EVENT-TABLE
- **Interval**: 0
- **Data Type**: 3

### Item: Get dbstat
- **Description**: Collect all metrics from pg_stat_database per database:
https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-DATABASE-VIEW
- **Interval**: 1m
- **Data Type**: 4

### Item: Get locks
- **Description**: Collect all metrics from pg_locks per database:
https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-TABLES
- **Interval**: 1m
- **Data Type**: 4

### Item: Ping
- **Description**: Used to test a connection to see if it is alive. It is set to 0 if the instance doesn't accept the connections.
- **Interval**: 1m
- **Data Type**: 3

### Item: Ping time
- **Description**: Used to get the `SELECT 1` query execution time.
- **Interval**: 1m
- **Data Type**: 0

### Item: Get queries
- **Description**: Collect all metrics by query execution time.
- **Interval**: 1m
- **Data Type**: 4

### Item: Replication: Standby count
- **Description**: Number of standby servers.
- **Interval**: 1m
- **Data Type**: 3

### Item: Replication: Lag in seconds
- **Description**: Replication lag with master, in seconds.
- **Interval**: 1m
- **Data Type**: 3

### Item: Replication: Recovery role
- **Description**: Replication role: 1 — recovery is still in progress (standby mode), 0 — master mode.
- **Interval**: 1m
- **Data Type**: 3

### Item: Replication: Status
- **Description**: Replication status: 0 — streaming is down, 1 — streaming is up, 2 — master mode.
- **Interval**: 1m
- **Data Type**: 3

### Item: Get transactions
- **Description**: Collect metrics by transaction execution time.
- **Interval**: 1m
- **Data Type**: 4

### Item: Transactions: Max active transaction time
- **Description**: Current max active transaction time.
- **Interval**: 0
- **Data Type**: 0

### Item: Transactions: Max idle transaction time
- **Description**: Current max idle transaction time.
- **Interval**: 0
- **Data Type**: 0

### Item: Transactions: Max prepared transaction time
- **Description**: Current max prepared transaction time.
- **Interval**: 0
- **Data Type**: 0

### Item: Transactions: Max waiting transaction time
- **Description**: Current max waiting transaction time.
- **Interval**: 0
- **Data Type**: 0

### Item: Uptime
- **Description**: Time since the server started.
- **Interval**: 1m
- **Data Type**: 3

### Item: Version
- **Description**: PostgreSQL version.
- **Interval**: 15m
- **Data Type**: 1

### Item: WAL: Segments count
- **Description**: Number of WAL segments.
- **Interval**: 0
- **Data Type**: 3

### Item: Get WAL
- **Description**: Collect write-ahead log (WAL) metrics.
- **Interval**: 5m
- **Data Type**: 4

### Item: WAL: Bytes written
- **Description**: WAL write, in bytes.
- **Interval**: 0
- **Data Type**: 3

