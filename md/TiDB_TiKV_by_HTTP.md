# TiDB TiKV by HTTP template description

The template to monitor TiKV server of TiDB cluster by Zabbix that works without any external scripts.
Most of the metrics are collected in one go, thanks to Zabbix bulk data collection.
Don't forget to change the macros {$TIKV.URL}, {$TIKV.PORT}.

Template `TiDB TiKV by HTTP` â€” collects metrics by HTTP agent from TiKV /metrics endpoint.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Coprocessor metrics discovery ](#discovery_coprocessor_metrics_discovery)
  * [Discovery QPS metrics discovery ](#discovery_qps_metrics_discovery)
  * [Discovery Scheduler metrics discovery ](#discovery_scheduler_metrics_discovery)
  * [Discovery Server errors discovery ](#discovery_server_errors_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| Scheduler: High priority commands total, rate | Total count of high priority commands per second. | tikv.commands_pri.high.rate | DEPENDENT | 0 |
| Scheduler: Low priority commands total, rate | Total count of low priority commands per second. | tikv.commands_pri.low.rate | DEPENDENT | 0 |
| Scheduler: Normal priority commands total, rate | Total count of normal priority commands per second. | tikv.commands_pri.normal.rate | DEPENDENT | 0 |
| Coprocessor: Requests, rate | Total number of coprocessor requests per second. | tikv.coprocessor_request.rate | DEPENDENT | 0 |
| Get coprocessor requests metrics | Get metrics of coprocessor requests. | tikv.coprocessor_requests.metrics | DEPENDENT | 0 |
| Coprocessor: Errors, rate | Total number of push down request error per second. | tikv.coprocessor_request_error.rate | DEPENDENT | 0 |
| Coprocessor: Response size, rate | The total size of coprocessor response per second. | tikv.coprocessor_response_bytes.rate | DEPENDENT | 0 |
| Coprocessor: RocksDB ops, rate | Total number of RocksDB internal operations from PerfContext per second. | tikv.coprocessor_rocksdb_perf.rate | DEPENDENT | 0 |
| Coprocessor: Scan keys, rate | Total number of scan keys observed per request per second. | tikv.coprocessor_scan_keys_sum.rate | DEPENDENT | 0 |
| CPU util | The CPU usage ratio on TiKV instance. | tikv.cpu.util | DEPENDENT | 0 |
| Bytes read | The total bytes of read in TiKV instance. | tikv.engine_flow_bytes.read | DEPENDENT | 0 |
| Bytes write | The total bytes of write in TiKV instance. | tikv.engine_flow_bytes.write | DEPENDENT | 0 |
| Store size | The storage size of TiKV instance. | tikv.engine_size | DEPENDENT | 0 |
| Get instance metrics | Get TiKV instance metrics. | tikv.get_metrics | HTTP_AGENT | no delay |
| Total query, rate | The total QPS in TiKV instance. | tikv.grpc_msg.rate | DEPENDENT | 0 |
| Get QPS metrics | Get QPS metrics in TiKV instance. | tikv.grpc_msgs.metrics | DEPENDENT | 0 |
| Total query errors, rate | The total number of gRPC message handling failure per second. | tikv.grpc_msg_fail.rate | DEPENDENT | 0 |
| Get failure msg metrics | Get metrics of reporting failure messages. | tikv.messages.failure.metrics | DEPENDENT | 0 |
| Server: failure messages total, rate | Total number of reporting failure messages per second. | tikv.messages.failure.rate | DEPENDENT | 0 |
| Regions, count | The number of regions collected in TiKV instance. | tikv.region_count | DEPENDENT | 0 |
| Regions, leader | The number of leaders in TiKV instance. | tikv.region_leader | DEPENDENT | 0 |
| RSS memory usage | Resident memory size in bytes. | tikv.rss_bytes | DEPENDENT | 0 |
| Get scheduler metrics | Get metrics of scheduler commands. | tikv.scheduler.metrics | DEPENDENT | 0 |
| Scheduler: Commands total, rate | Total number of commands per second. | tikv.scheduler_commands.rate | DEPENDENT | 0 |
| Scheduler: Pending commands | The total number of pending commands. The scheduler receives commands from clients, executes them against the MVCC layer storage engine. | tikv.scheduler_contex | DEPENDENT | 0 |
| Scheduler: Busy, rate | The total count of too busy schedulers per second. | tikv.scheduler_too_busy.rate | DEPENDENT | 0 |
| Snapshot: Applying | The total amount of raftstore snapshot traffic. | tikv.snapshot.applying | DEPENDENT | 0 |
| Snapshot: Receiving | The total amount of raftstore snapshot traffic. | tikv.snapshot.receiving | DEPENDENT | 0 |
| Snapshot: Sending | The total amount of raftstore snapshot traffic. | tikv.snapshot.sending | DEPENDENT | 0 |
| Storage: commands total, rate | Total number of commands received per second. | tikv.storage_command.rate | DEPENDENT | 0 |
| Available size | The available capacity of TiKV instance. | tikv.store_size.available | DEPENDENT | 0 |
| Capacity size | The capacity size of TiKV instance. | tikv.store_size.capacity | DEPENDENT | 0 |
| Get store size metrics | Get capacity metrics of TiKV instance. | tikv.store_size.metrics | DEPENDENT | 0 |
| Uptime | The runtime of each TiKV instance. | tikv.uptime | DEPENDENT | 0 |
| Snapshot: Pending tasks | The number of tasks currently running by the worker or pending. | tikv.worker_pending_task | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$TIKV.COPROCESSOR.ERRORS.MAX.WARN} | 1 |
| {$TIKV.PENDING_COMMANDS.MAX.WARN} | 1 |
| {$TIKV.PENDING_TASKS.MAX.WARN} | 1 |
| {$TIKV.PORT} | 20180 |
| {$TIKV.STORE.ERRORS.MAX.WARN} | 1 |
| {$TIKV.URL} | localhost |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Too many coprocessor request error | WARNING | no description | min(/TiDB TiKV by HTTP/tikv.coprocessor_request_error.rate,5m)>{$TIKV.COPROCESSOR.ERRORS.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Too many pending commands | AVERAGE | no description | min(/TiDB TiKV by HTTP/tikv.scheduler_contex,5m)>{$TIKV.PENDING_COMMANDS.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| has been restarted | INFO | Uptime is less than 10 minutes. | last(/TiDB TiKV by HTTP/tikv.uptime)<10m | [{"tag": "scope", "value": "notice"}] | no url |
| Too many pending tasks | AVERAGE | no description | min(/TiDB TiKV by HTTP/tikv.worker_pending_task,5m)>{$TIKV.PENDING_TASKS.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Coprocessor metrics discovery | tikv.coprocessor.discovery | Discovery coprocessor metrics. | DEPENDENT | no lifetime | 0 |
| QPS metrics discovery | tikv.qps.discovery | Discovery QPS metrics. | DEPENDENT | no lifetime | 0 |
| Scheduler metrics discovery | tikv.scheduler.discovery | Discovery scheduler metrics. | DEPENDENT | no lifetime | 0 |
| Server errors discovery | tikv.server_report_failure.discovery | Discovery server errors metrics. | DEPENDENT | no lifetime | 0 |


<a name="discovery_coprocessor_metrics_discovery"></a>

## Discovery Coprocessor metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Coprocessor: {#REQ_TYPE} metrics | Get metrics of {#REQ_TYPE} requests. | tikv.coprocessor_request.metrics[{#REQ_TYPE}] | DEPENDENT |
| Coprocessor: {#REQ_TYPE} requests, rate | Total number of coprocessor requests per second. | tikv.coprocessor_request.rate[{#REQ_TYPE}] | DEPENDENT |
| Coprocessor: {#REQ_TYPE} errors, rate | Total number of push down request error per second. | tikv.coprocessor_request_error.rate[{#REQ_TYPE}] | DEPENDENT |
| Coprocessor: {#REQ_TYPE} RocksDB ops, rate | Total number of RocksDB internal operations from PerfContext per second. | tikv.coprocessor_rocksdb_perf.rate[{#REQ_TYPE}] | DEPENDENT |
| Coprocessor: {#REQ_TYPE} scan keys, rate | Total number of scan keys observed per request per second. | tikv.coprocessor_scan_keys.rate[{#REQ_TYPE}] | DEPENDENT |


<a name="discovery_qps_metrics_discovery"></a>

## Discovery QPS metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Query: {#TYPE}, rate | The QPS per command in TiKV instance. | tikv.grpc_msg.rate[{#TYPE}] | DEPENDENT |


<a name="discovery_scheduler_metrics_discovery"></a>

## Discovery Scheduler metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Scheduler: commands {#STAGE}, rate | Total number of commands on each stage per second. | tikv.scheduler_stage.rate[{#STAGE}] | DEPENDENT |


<a name="discovery_server_errors_discovery"></a>

## Discovery Server errors discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Store_id {#STORE_ID}: failure messages "{#TYPE}", rate | Total number of reporting failure messages. The metric has two labels: type and store_id. type represents the failure type, and store_id represents the destination peer store id. | tikv.messages.failure.rate[{#STORE_ID},{#TYPE}] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Store_id {#STORE_ID}: Too many failure messages "{#TYPE}" | WARNING | Indicates that the remote TiKV cannot be connected. | min(/TiDB TiKV by HTTP/tikv.messages.failure.rate[{#STORE_ID},{#TYPE}],5m)>{$TIKV.STORE.ERRORS.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |

