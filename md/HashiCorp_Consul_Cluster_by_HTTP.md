# HashiCorp Consul Cluster by HTTP template description

Get HashiCorp Consul Cluster services and nodes by HTTP agent from API endpoints.

Don't forget to change macros {$CONSUL.CLUSTER.URL}, {$CONSUL.TOKEN}.
Some metrics may not be collected depending on your HashiCorp Consul instance version and configuration.
More information about metrics you can find in official documentation: https://www.consul.io/docs/agent/telemetry

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Consul cluster nodes discovery ](#discovery_consul_cluster_nodes_discovery)
  * [Discovery Consul cluster services discovery ](#discovery_consul_cluster_services_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| Get services | Catalog of services registered in a given datacenter. | consul.get_catalog_services | HTTP_AGENT | no delay |
| Get nodes Serf health status | Get Serf Health Status for all agents in cluster. | consul.get_cluster_serf | HTTP_AGENT | no delay |
| Cluster leader | Current leader address. | consul.get_leader | HTTP_AGENT | no delay |
| Get nodes | Catalog of nodes registered in a given datacenter. | consul.get_nodes | HTTP_AGENT | no delay |
| Nodes: peers | The number of Raft peers for the datacenter in which the agent is running. | consul.get_peers | HTTP_AGENT | no delay |
| Nodes: critical | Number of agents on current dc with serf health status 'critical'. | consul.nodes_critical | DEPENDENT | 0 |
| Nodes: passing | Number of agents on current dc with serf health status 'passing'. | consul.nodes_passing | DEPENDENT | 0 |
| Nodes: total | Number of nodes on current dc. | consul.nodes_total | DEPENDENT | 0 |
| Nodes: warning | Number of agents on current dc with serf health status 'warning'. | consul.nodes_warning | DEPENDENT | 0 |
| Services: total | Number of services on current dc. | consul.services_total | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$CONSUL.API.PORT} | 8500 |
| {$CONSUL.API.SCHEME} | http |
| {$CONSUL.CLUSTER.URL} | http://localhost:8500 |
| {$CONSUL.LLD.FILTER.NODE_NAME.MATCHES} | .* |
| {$CONSUL.LLD.FILTER.NODE_NAME.NOT_MATCHES} | CHANGE IF NEEDED |
| {$CONSUL.LLD.FILTER.SERVICE_NAME.MATCHES} | .* |
| {$CONSUL.LLD.FILTER.SERVICE_NAME.NOT_MATCHES} | CHANGE IF NEEDED |
| {$CONSUL.NAMESPACE} | no value |
| {$CONSUL.SERVICE_NODES.CRITICAL.MAX.AVG} | 0 |
| {$CONSUL.TOKEN} | <PUT YOUR AUTH TOKEN> |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Leader has been changed | INFO | Consul cluster version has changed. Acknowledge to close the problem manually. | last(/HashiCorp Consul Cluster by HTTP/consul.get_leader,#1)<>last(/HashiCorp Consul Cluster by HTTP/consul.get_leader,#2) and length(last(/HashiCorp Consul Cluster by HTTP/consul.get_leader))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| One or more nodes in cluster in 'critical' state | AVERAGE | One or more agents on current dc with serf health status 'critical'. | last(/HashiCorp Consul Cluster by HTTP/consul.nodes_critical)>0 | [{"tag": "scope", "value": "availability"}] | no url |
| One or more nodes in cluster in 'warning' state | WARNING | One or more agents on current dc with serf health status 'warning'. | last(/HashiCorp Consul Cluster by HTTP/consul.nodes_warning)>0 | [{"tag": "scope", "value": "availability"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Consul cluster nodes discovery | consul.lld_nodes | no description | DEPENDENT | no lifetime | 0 |
| Consul cluster services discovery | consul.lld_services | no description | DEPENDENT | no lifetime | 0 |


<a name="discovery_consul_cluster_nodes_discovery" />

## Discovery Consul cluster nodes discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Node ["{#NODE_NAME}"]: Serf Health | Node Serf Health Status. | consul.serf.health["{#NODE_NAME}"] | DEPENDENT |


<a name="discovery_consul_cluster_services_discovery" />

## Discovery Consul cluster services discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| ["{#SERVICE_NAME}"]: Get raw service state | Retrieve service instances providing the service indicated on the path. | consul.get_service_stats["{#SERVICE_NAME}"] | HTTP_AGENT |
| Service ["{#SERVICE_NAME}"]: Nodes critical | The number of nodes with service status `critical` from those registered. | consul.service.nodes_critical["{#SERVICE_NAME}"] | DEPENDENT |
| Service ["{#SERVICE_NAME}"]: Nodes passing | The number of nodes with service status `passing` from those registered. | consul.service.nodes_passing["{#SERVICE_NAME}"] | DEPENDENT |
| Service ["{#SERVICE_NAME}"]: Nodes warning | The number of nodes with service status `warning` from those registered. | consul.service.nodes_warning["{#SERVICE_NAME}"] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Service ["{#SERVICE_NAME}"]: Too many nodes with service status 'critical' | AVERAGE | One or more nodes with service status 'critical'. | last(/HashiCorp Consul Cluster by HTTP/consul.service.nodes_critical["{#SERVICE_NAME}"])>{$CONSUL.CLUSTER.SERVICE_NODES.CRITICAL.MAX.AVG:"{#SERVICE_NAME}"} | [{"tag": "scope", "value": "availability"}] | no url |

