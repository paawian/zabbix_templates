# Zookeeper by HTTP template description

This template is designed for the effortless deployment of Apache Zookeeper monitoring by Zabbix via HTTP and doesn't require any external scripts.

This template works with standalone and cluster instances. Metrics are collected from each Zookeeper node by requests to AdminServer

Setup:

1. Enable the AdminServer and configure the parameters according to the official documentation:
https://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_adminserver_config

2. Set the hostname or IP address of the Apache Zookeeper host in the '{$ZOOKEEPER.HOST}' macro. You can also change the '{$ZOOKEEPER.COMMAND_URL}', '{$ZOOKEEPER.PORT}' and '{$ZOOKEEPER.SCHEME}' macros if necessary.

You can discuss this template or leave feedback on our forum:
https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Clients discovery ](#discovery_clients_discovery)
  * [Discovery Leader metrics discovery ](#discovery_leader_metrics_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| Approximate data size | Data tree size in bytes.The size includes the znode path and its value. | zookeeper.approximate_data_size | DEPENDENT | 0 |
| Election time, avg | Time between entering and leaving election. | zookeeper.avg_election_time | DEPENDENT | 0 |
| Fsync time, avg | Time to fsync transaction log. | zookeeper.avg_fsynctime | DEPENDENT | 0 |
| Latency, avg | The average amount of time it takes for the server to respond to a client request. | zookeeper.avg_latency | DEPENDENT | 0 |
| Snapshot write time, avg | Average time to write a snapshot. | zookeeper.avg_snapshottime | DEPENDENT | 0 |
| Bytes received per sec | Number of bytes received per second. | zookeeper.bytes_received_count.rate | DEPENDENT | 0 |
| Elections | Number of elections happened. | zookeeper.cnt_election_time | DEPENDENT | 0 |
| Fsync | Count of performed fsyncs. | zookeeper.cnt_fsynctime | DEPENDENT | 0 |
| Snapshot writes | Count of performed snapshot writes. | zookeeper.cnt_snapshottime | DEPENDENT | 0 |
| Commit per sec | The number of commits performed per second | zookeeper.commit_count.rate | DEPENDENT | 0 |
| Drop connections per sec | Rate of connection drops. | zookeeper.connection_drop_count.rate | DEPENDENT | 0 |
| Rejected connections per sec | Rate of connection rejected. | zookeeper.connection_rejected.rate | DEPENDENT | 0 |
| Revalidate connections per sec | Rate of connection revalidations. | zookeeper.connection_revalidate_count.rate | DEPENDENT | 0 |
| Diff syncs per sec | Number of diff syncs performed per second | zookeeper.diff_count.rate | DEPENDENT | 0 |
| Ephemeral nodes count | Number of ephemeral nodes that a zookeeper server has in its data tree. | zookeeper.ephemerals_count | DEPENDENT | 0 |
| Get connections stats | Get information on client connections to server. Note, depending on the number of client connections this operation may be expensive (i.e. impact server performance). | zookeeper.get_connections_stats | HTTP_AGENT | no delay |
| Get server metrics | no description | zookeeper.get_metrics | HTTP_AGENT | no delay |
| Global sessions | Number of global sessions. | zookeeper.global_sessions | DEPENDENT | 0 |
| Local sessions | Number of local sessions. | zookeeper.local_sessions | DEPENDENT | 0 |
| Looking per sec | Rate of transitions into looking state. | zookeeper.looking_count.rate | DEPENDENT | 0 |
| File descriptors, max | Maximum number of file descriptors that a zookeeper server can open. | zookeeper.max_file_descriptor_count | DEPENDENT | 0 |
| Latency, max | The maximum amount of time it takes for the server to respond to a client request. | zookeeper.max_latency | DEPENDENT | 0 |
| Latency, min | The minimum amount of time it takes for the server to respond to a client request. | zookeeper.min_latency | DEPENDENT | 0 |
| Alive connections | Number of active clients connected to a zookeeper server. | zookeeper.num_alive_connections | DEPENDENT | 0 |
| File descriptors, open | Number of file descriptors that a zookeeper server has open. | zookeeper.open_file_descriptor_count | DEPENDENT | 0 |
| Outstanding requests | The number of queued requests when the server is under load and is receiving more sustained requests than it can process. | zookeeper.outstanding_requests | DEPENDENT | 0 |
| Packets received per sec | The number of zookeeper packets received by a server per second. | zookeeper.packets_received.rate | DEPENDENT | 0 |
| Packets sent per sec | The number of zookeeper packets sent from a server per second. | zookeeper.packets_sent | DEPENDENT | 0 |
| Revalidate per sec | Rate of revalidations. | zookeeper.revalidate_count.rate | DEPENDENT | 0 |
| Server mode | Mode of the server. In an ensemble, this may either be leader or follower. Otherwise, it is standalone | zookeeper.server_state | DEPENDENT | 0 |
| Snap syncs per sec | Number of snap syncs performed per second | zookeeper.snap_count.rate | DEPENDENT | 0 |
| Uptime | Uptime that a peer has been in a table leading/following/observing state. | zookeeper.uptime | DEPENDENT | 0 |
| Version | Version of Zookeeper server. | zookeeper.version | DEPENDENT | 0 |
| Watch count | Number of watches currently set on the local ZooKeeper process. | zookeeper.watch_count | DEPENDENT | 0 |
| Znode count | The number of znodes in the ZooKeeper namespace (the data) | zookeeper.znode_count | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$ZOOKEEPER.COMMAND_URL} | commands |
| {$ZOOKEEPER.FILE_DESCRIPTORS.MAX.WARN} | 85 |
| {$ZOOKEEPER.HOST} | <SET ZOOKEEPER HOST> |
| {$ZOOKEEPER.OUTSTANDING_REQ.MAX.WARN} | 10 |
| {$ZOOKEEPER.PENDING_SYNCS.MAX.WARN} | 10 |
| {$ZOOKEEPER.PORT} | 8080 |
| {$ZOOKEEPER.SCHEME} | http |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Too many queued requests | AVERAGE | Number of queued requests in the server. This goes up when the server receives more requests than it can process. | min(/Zookeeper by HTTP/zookeeper.outstanding_requests,5m)>{$ZOOKEEPER.OUTSTANDING_REQ.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Server mode has changed | INFO | Zookeeper node state has changed. Acknowledge to close the problem manually. | last(/Zookeeper by HTTP/zookeeper.server_state,#1)<>last(/Zookeeper by HTTP/zookeeper.server_state,#2) and length(last(/Zookeeper by HTTP/zookeeper.server_state))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| Failed to fetch info data | WARNING | Zabbix has not received data for items for the last 10 minutes | nodata(/Zookeeper by HTTP/zookeeper.uptime,10m)=1 | [{"tag": "scope", "value": "availability"}] | no url |
| Version has changed | INFO | Zookeeper version has changed. Acknowledge to close the problem manually. | last(/Zookeeper by HTTP/zookeeper.version,#1)<>last(/Zookeeper by HTTP/zookeeper.version,#2) and length(last(/Zookeeper by HTTP/zookeeper.version))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| Too many file descriptors used | WARNING | Number of file descriptors used more than {$ZOOKEEPER.FILE_DESCRIPTORS.MAX.WARN}% of the available number of file descriptors. | min(/Zookeeper by HTTP/zookeeper.open_file_descriptor_count,5m) * 100 / last(/Zookeeper by HTTP/zookeeper.max_file_descriptor_count) > {$ZOOKEEPER.FILE_DESCRIPTORS.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Clients discovery | zookeeper.clients | Get list of client connections.<br>Note, depending on the number of client connections this operation may be expensive (i.e. impact server performance). | HTTP_AGENT | no lifetime | 1h |
| Leader metrics discovery | zookeeper.metrics.leader | Additional metrics for leader node | DEPENDENT | no lifetime | 0 |


<a name="discovery_clients_discovery" />

## Discovery Clients discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Zookeeper client {#TYPE} [{#CLIENT}]: Latency, avg | The average amount of time it takes for the server to respond to a client request. | zookeeper.avg_latency[{#TYPE},{#CLIENT}] | DEPENDENT |
| Zookeeper client {#TYPE} [{#CLIENT}]: Get client info | The item gets information about "{#CLIENT}" client of "{#TYPE}" type. | zookeeper.client_info[{#TYPE},{#CLIENT}] | DEPENDENT |
| Zookeeper client {#TYPE} [{#CLIENT}]: Latency, max | The maximum amount of time it takes for the server to respond to a client request. | zookeeper.max_latency[{#TYPE},{#CLIENT}] | DEPENDENT |
| Zookeeper client {#TYPE} [{#CLIENT}]: Latency, min | The minimum amount of time it takes for the server to respond to a client request. | zookeeper.min_latency[{#TYPE},{#CLIENT}] | DEPENDENT |
| Zookeeper client {#TYPE} [{#CLIENT}]: Outstanding requests | The number of queued requests when the server is under load and is receiving more sustained requests than it can process. | zookeeper.outstanding_requests[{#TYPE},{#CLIENT}] | DEPENDENT |
| Zookeeper client {#TYPE} [{#CLIENT}]: Packets received per sec | The number of packets received. | zookeeper.packets_received[{#TYPE},{#CLIENT}] | DEPENDENT |
| Zookeeper client {#TYPE} [{#CLIENT}]: Packets sent per sec | The number of packets sent. | zookeeper.packets_sent[{#TYPE},{#CLIENT}] | DEPENDENT |


<a name="discovery_leader_metrics_discovery" />

## Discovery Leader metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Learners{#SINGLETON} | Number of learners. | zookeeper.learners[{#SINGLETON}] | DEPENDENT |
| Pending syncs{#SINGLETON} | Number of pending syncs to carry out to ZooKeeper ensemble followers. | zookeeper.pending_syncs[{#SINGLETON}] | DEPENDENT |
| Quorum size{#SINGLETON} | no description | zookeeper.quorum_size[{#SINGLETON}] | DEPENDENT |
| Synced followers{#SINGLETON} | Number of synced followers reported when a node server_state is leader. | zookeeper.synced_followers[{#SINGLETON}] | DEPENDENT |
| Synced non-voting follower{#SINGLETON} | Number of synced voting followers reported when a node server_state is leader. | zookeeper.synced_non_voting_followers[{#SINGLETON}] | DEPENDENT |
| Synced observers{#SINGLETON} | Number of synced observers. | zookeeper.synced_observers[{#SINGLETON}] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Too many pending syncs | AVERAGE | no description | min(/Zookeeper by HTTP/zookeeper.pending_syncs[{#SINGLETON}],5m)>{$ZOOKEEPER.PENDING_SYNCS.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Too few active followers | AVERAGE | The number of followers should equal the total size of your ZooKeeper ensemble, minus 1 (the leader is not included in the follower count). If the ensemble fails to maintain quorum, all automatic failover features are suspended. | last(/Zookeeper by HTTP/zookeeper.synced_followers[{#SINGLETON}]) < last(/Zookeeper by HTTP/zookeeper.quorum_size[{#SINGLETON}])-1 | [{"tag": "scope", "value": "availability"}] | no url |

