# GitLab by HTTP template description

Get GitLab metrics by HTTP agent from Prometheus metrics endpoint.

To access the metrics, the client IP address must be explicitly allowed. See https://docs.gitlab.com/ee/administration/monitoring/ip_whitelist.html.
Or second method, using token variable from http://your.gitlab.address/admin/health_check (fill {$GITLAB.HEALTH.TOKEN} macro with variable path like "?token=your_token").
Don't forget change macros {$GITLAB.URL}.
Some metrics may not be collected depending on your Gitlab instance version and configuration. See (Gitlab's documentation[)https://docs.gitlab.com/ee/administration/monitoring/prometheus/gitlab_metrics.html] for further information about its metric collection.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Puma metrics discovery ](#discovery_puma_metrics_discovery)
  * [Discovery Unicorn metrics discovery ](#discovery_unicorn_metrics_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| Cache: Misses rate, total | The cache read miss count. | gitlab.cache.misses_total.rate | DEPENDENT | 0 |
| Cache: Operations rate, total | The count of cache operations. | gitlab.cache.operations_total.rate | DEPENDENT | 0 |
| Database: Connection pool, busy | Connections to the main database in use where the owner is still alive. | gitlab.database.connection_pool_busy | DEPENDENT | 0 |
| Database: Connection pool, current | Current connections to the main database in the pool. | gitlab.database.connection_pool_connections | DEPENDENT | 0 |
| Database: Connection pool, dead | Connections to the main database in use where the owner is not alive. | gitlab.database.connection_pool_dead | DEPENDENT | 0 |
| Database: Connection pool, idle | Connections to the main database not in use. | gitlab.database.connection_pool_idle | DEPENDENT | 0 |
| Database: Connection pool, size | Total connection to the main database pool capacity. | gitlab.database.connection_pool_size | DEPENDENT | 0 |
| Database: Connection pool, waiting | Threads currently waiting on this queue. | gitlab.database.connection_pool_waiting | DEPENDENT | 0 |
| Version | Version of the GitLab instance. | gitlab.deployments.version | DEPENDENT | 0 |
| User CAPTCHA logins failed, total | Counter of failed CAPTCHA attempts during login. | gitlab.failed_login_captcha_total | DEPENDENT | 0 |
| Get instance metrics | no description | gitlab.get_metrics | HTTP_AGENT | no delay |
| HTTP requests rate, 4xx | Number of handle failures of requests with code 4XX. | gitlab.http.requests.4xx.rate | DEPENDENT | 0 |
| HTTP requests rate, 5xx | Number of handle failures of requests with HTTP-code 5xx. | gitlab.http.requests.5xx.rate | DEPENDENT | 0 |
| HTTP requests rate, total | Number of requests received into the system. | gitlab.http.requests.rate | DEPENDENT | 0 |
| Application server status | Checks whether the application server is running. This probe is used to know if Rails Controllers are not deadlocked due to a multi-threading. | gitlab.liveness | HTTP_AGENT | no delay |
| Pipelines: Auto DevOps pipelines, total | Counter of completed Auto DevOps pipelines. | gitlab.pipeline.auto_devops_completed.total | DEPENDENT | 0 |
| Pipelines: Auto DevOps pipelines, failed | Counter of completed Auto DevOps pipelines with status "failed". | gitlab.pipeline.auto_devops_completed_total.failed | DEPENDENT | 0 |
| Pipelines: Created, total | Counter of pipelines created. | gitlab.pipeline.created_total | DEPENDENT | 0 |
| Pipelines: CI/CD creation duration | The sum of the time in seconds it takes to create a CI/CD pipeline. | gitlab.pipeline.pipeline_creation | DEPENDENT | 0 |
| Pipelines: Pipelines: CI/CD creation count | The count of the time it takes to create a CI/CD pipeline. | gitlab.pipeline.pipeline_creation.count | DEPENDENT | 0 |
| Pipelines: Processing events, total | Total amount of pipeline processing events. | gitlab.pipeline.processing_events_total | DEPENDENT | 0 |
| Instance readiness check | The readiness probe checks whether the GitLab instance is ready to accept traffic via Rails Controllers. | gitlab.readiness | HTTP_AGENT | no delay |
| Redis: Client exceptions rate, cache | Number of Redis client exceptions per second. (Instance: cache) | gitlab.redis.client_exceptions.cache.rate | DEPENDENT | 0 |
| Redis: Client exceptions rate, queues | Number of Redis client exceptions per second. (Instance: queues) | gitlab.redis.client_exceptions.queues.rate | DEPENDENT | 0 |
| Redis: client exceptions rate, shared_state | Number of Redis client exceptions per second. (Instance: shared_state) | gitlab.redis.client_exceptions.shared_state.rate | DEPENDENT | 0 |
| Redis: Client requests rate, cache | Number of Redis client requests per second. (Instance: cache) | gitlab.redis.client_requests.cache.rate | DEPENDENT | 0 |
| Redis: Client requests rate, queues | Number of Redis client requests per second. (Instance: queues) | gitlab.redis.client_requests.queues.rate | DEPENDENT | 0 |
| Redis: Client requests rate, shared_state | Number of Redis client requests per second. (Instance: shared_state) | gitlab.redis.client_requests.shared_state.rate | DEPENDENT | 0 |
| Ruby: File descriptors opened, avg | Average number of opened file descriptors. | gitlab.ruby.file_descriptors.avg | DEPENDENT | 0 |
| Ruby: File descriptors opened, max | Maximum number of opened file descriptors. | gitlab.ruby.file_descriptors.max | DEPENDENT | 0 |
| Ruby: File descriptors opened, min | Minimum number of opened file descriptors. | gitlab.ruby.file_descriptors.min | DEPENDENT | 0 |
| Ruby: CPU  usage per second | Average CPU time util in seconds. | gitlab.ruby.process_cpu_seconds.rate | DEPENDENT | 0 |
| Ruby: File descriptors, max | Maximum number of open file descriptors per process. | gitlab.ruby.process_max_fds | DEPENDENT | 0 |
| Ruby: RSS memory, avg | Average RSS Memory usage in bytes. | gitlab.ruby.process_resident_memory_bytes.avg | DEPENDENT | 0 |
| Ruby: RSS memory, max | Maximum RSS Memory usage in bytes. | gitlab.ruby.process_resident_memory_bytes.max | DEPENDENT | 0 |
| Ruby: RSS memory, min | Minimum RSS Memory usage in bytes. | gitlab.ruby.process_resident_memory_bytes.min | DEPENDENT | 0 |
| Ruby: First process start time | Minimum UNIX timestamp of ruby processes start time. | gitlab.ruby.process_start_time_seconds.first | DEPENDENT | 0 |
| Ruby: Last process start time | Maximum UNIX timestamp ruby processes start time. | gitlab.ruby.process_start_time_seconds.last | DEPENDENT | 0 |
| Ruby: Running_threads | Number of running Ruby threads. | gitlab.ruby.threads_running | DEPENDENT | 0 |
| User CAPTCHA logins, total | Counter of successful CAPTCHA attempts during login. | gitlab.successful_login_captcha_total | DEPENDENT | 0 |
| Transactions per second | Transactions per second (gitlab_transaction_* metrics). | gitlab.transactions.rate | DEPENDENT | 0 |
| Upload file does not exist | Number of times an upload record could not find its file. | gitlab.upload_file_does_not_exist | DEPENDENT | 0 |
| User logins, total | Counter of how many users have logged in since GitLab was started or restarted. | gitlab.user_session_logins_total | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$GITLAB.HEALTH.TOKEN} | no value |
| {$GITLAB.HTTP.FAIL.MAX.WARN} | 2 |
| {$GITLAB.OPEN.FDS.MAX.WARN} | 90 |
| {$GITLAB.PUMA.QUEUE.MAX.WARN} | 1 |
| {$GITLAB.PUMA.UTILIZATION.MAX.WARN} | 90 |
| {$GITLAB.REDIS.FAIL.MAX.WARN} | 2 |
| {$GITLAB.UNICORN.QUEUE.MAX.WARN} | 1 |
| {$GITLAB.UNICORN.UTILIZATION.MAX.WARN} | 90 |
| {$GITLAB.URL} | http://localhost |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Version has changed | INFO | The GitLab version has changed. Acknowledge to close the problem manually. | last(/GitLab by HTTP/gitlab.deployments.version,#1)<>last(/GitLab by HTTP/gitlab.deployments.version,#2) and length(last(/GitLab by HTTP/gitlab.deployments.version))>0 | [{"tag": "scope", "value": "notice"}] | no url |
| Too many HTTP requests failures | WARNING | "Too many requests failed on GitLab instance with 5xx HTTP code" | min(/GitLab by HTTP/gitlab.http.requests.5xx.rate,5m)>{$GITLAB.HTTP.FAIL.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Liveness check was failed | HIGH | The application server is not running or Rails Controllers are deadlocked. | last(/GitLab by HTTP/gitlab.liveness)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| Gitlab instance is not able to accept traffic | HIGH | no description | last(/GitLab by HTTP/gitlab.readiness)=0 | [{"tag": "scope", "value": "availability"}] | no url |
| Too many Redis cache client exceptions | WARNING | "Too many  Redis client exceptions during the requests to  Redis instance cache." | min(/GitLab by HTTP/gitlab.redis.client_exceptions.cache.rate,5m)>{$GITLAB.REDIS.FAIL.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Too many Redis queues client exceptions | WARNING | "Too many  Redis client exceptions during the requests to  Redis instance queues." | min(/GitLab by HTTP/gitlab.redis.client_exceptions.queues.rate,5m)>{$GITLAB.REDIS.FAIL.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Too many Redis shared_state client exceptions | WARNING | "Too many  Redis client exceptions during the requests to  Redis instance shared_state." | min(/GitLab by HTTP/gitlab.redis.client_exceptions.shared_state.rate,5m)>{$GITLAB.REDIS.FAIL.MAX.WARN} | [{"tag": "scope", "value": "availability"}] | no url |
| Failed to fetch info data | WARNING | Zabbix has not received a metrics data for the last 30 minutes | nodata(/GitLab by HTTP/gitlab.ruby.threads_running,30m)=1 | [{"tag": "scope", "value": "availability"}] | no url |
| Current number of open files is too high | WARNING | no description | min(/GitLab by HTTP/gitlab.ruby.file_descriptors.max,5m)/last(/GitLab by HTTP/gitlab.ruby.process_max_fds)*100>{$GITLAB.OPEN.FDS.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Puma metrics discovery | gitlab.puma.discovery | Discovery of Puma specific metrics when Puma is used. | HTTP_AGENT | no lifetime | 3h |
| Unicorn metrics discovery | gitlab.unicorn.discovery | DiscoveryUnicorn specific metrics, when Unicorn is used. | HTTP_AGENT | no lifetime | 3h |


<a name="discovery_puma_metrics_discovery" />

## Discovery Puma metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Active connections | Number of puma threads processing a request. | gitlab.puma.active_connections[{#SINGLETON}] | DEPENDENT |
| Idle threads | The number of spawned puma threads which are not processing a request. | gitlab.puma.idle_threads[{#SINGLETON}] | DEPENDENT |
| Killer terminations, total | The number of workers terminated by PumaWorkerKiller. | gitlab.puma.killer_terminations_total[{#SINGLETON}] | DEPENDENT |
| Max threads | The maximum number of puma worker threads. | gitlab.puma.max_threads[{#SINGLETON}] | DEPENDENT |
| Pool capacity | The number of requests the puma worker is capable of taking right now. | gitlab.puma.pool_capacity[{#SINGLETON}] | DEPENDENT |
| Queued connections | The number of connections in that puma worker's "todo" set waiting for a worker thread. | gitlab.puma.queued_connections[{#SINGLETON}] | DEPENDENT |
| Running threads | The number of running puma threads. | gitlab.puma.running[{#SINGLETON}] | DEPENDENT |
| Running workers | The number of booted puma workers. | gitlab.puma.running_workers[{#SINGLETON}] | DEPENDENT |
| Stale workers | The number of old puma workers. | gitlab.puma.stale_workers[{#SINGLETON}] | DEPENDENT |
| Workers | Total number of puma workers. | gitlab.puma.workers[{#SINGLETON}] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Puma is queueing requests | WARNING | no description | min(/GitLab by HTTP/gitlab.puma.queued_connections[{#SINGLETON}],15m)>{$GITLAB.PUMA.QUEUE.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Puma instance thread utilization is too high | WARNING | no description | min(/GitLab by HTTP/gitlab.puma.active_connections[{#SINGLETON}],5m)/last(/GitLab by HTTP/gitlab.puma.max_threads[{#SINGLETON}])*100>{$GITLAB.PUMA.UTILIZATION.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |


<a name="discovery_unicorn_metrics_discovery" />

## Discovery Unicorn metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Unicorn: Active connections | The number of active Unicorn connections. | gitlab.unicorn.active_connections[{#SINGLETON}] | DEPENDENT |
| Unicorn: Queued connections | The number of queued Unicorn connections. | gitlab.unicorn.queued_connections[{#SINGLETON}] | DEPENDENT |
| Unicorn: Workers | The number of Unicorn workers | gitlab.unicorn.unicorn_workers[{#SINGLETON}] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Unicorn is queueing requests | WARNING | no description | min(/GitLab by HTTP/gitlab.unicorn.queued_connections[{#SINGLETON}],5m)>{$GITLAB.UNICORN.QUEUE.MAX.WARN} | [{"tag": "scope", "value": "performance"}] | no url |
| Unicorn worker utilization is too high | WARNING | no description | min(/GitLab by HTTP/gitlab.unicorn.active_connections[{#SINGLETON}],5m)/last(/GitLab by HTTP/gitlab.unicorn.unicorn_workers[{#SINGLETON}])*100>{$GITLAB.UNICORN.UTILIZATION.MAX.WARN} | [{"tag": "scope", "value": "capacity"}] | no url |

