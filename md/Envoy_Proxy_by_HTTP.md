# Envoy Proxy by HTTP template description

Get Envoy Proxy metrics by HTTP agent from metrics endpoint.
https://www.envoyproxy.io/docs/envoy/v1.20.0/operations/stats_overview

Don't forget to change macros {$ENVOY.URL}, {$ENVOY.METRICS.PATH}.
Some metrics may not be collected depending on your Envoy Proxy instance version and configuration.

You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback

Generated by official Zabbix template tool "Templator"

## Summary
* [items](#items)
* [macros](#macros)
* [triggers](#triggers)
* [discoveries](#discoveries)
  * [Discovery Cluster metrics discovery ](#discovery_cluster_metrics_discovery)
  * [Discovery HTTP metrics discovery ](#discovery_http_metrics_discovery)
  * [Discovery Listeners metrics discovery ](#discovery_listeners_metrics_discovery)

<a name="items"></a>

## Items
| name | description | key | type | delay |
| ------------- |------------- |------------- |------------- |------------- |
| Clusters, active | Number of currently active (warmed) clusters. | envoy.cluster_manager.active_clusters | DEPENDENT | 0 |
| Clusters, added rate | Total clusters added (either via static config or CDS) per second. | envoy.cluster_manager.cluster_added.rate | DEPENDENT | 0 |
| Clusters, modified rate | Total clusters modified (via CDS) per second. | envoy.cluster_manager.cluster_modified.rate | DEPENDENT | 0 |
| Clusters, removed rate | Total clusters removed (via CDS) per second. | envoy.cluster_manager.cluster_removed.rate | DEPENDENT | 0 |
| Clusters, updates rate | Total cluster updates per second. | envoy.cluster_manager.cluster_updated.rate | DEPENDENT | 0 |
| Clusters, warming | Number of currently warming (not active) clusters. | envoy.cluster_manager.warming_clusters | DEPENDENT | 0 |
| Filesystem, flushed by timer rate | Total number of times internal flush buffers are written to a file due to flush timeout per second. | envoy.filesystem.flushed_by_timer.rate | DEPENDENT | 0 |
| Filesystem, reopen failed rate | Total number of times a file was failed to be opened per second. | envoy.filesystem.reopen_failed.rate | DEPENDENT | 0 |
| Filesystem, write completed rate | Total number of times a file was written per second. | envoy.filesystem.write_completed.rate | DEPENDENT | 0 |
| Filesystem, write failed rate | Total number of times an error occurred during a file write operation per second. | envoy.filesystem.write_failed.rate | DEPENDENT | 0 |
| Get node metrics | Get server metrics. | envoy.get_metrics | HTTP_AGENT | no delay |
| Listeners, added | Total listeners added (either via static config or LDS) per second. | envoy.listener_manager.listener_added.rate | DEPENDENT | 0 |
| Listeners, create failure | Total failed listener object additions to workers per second. | envoy.listener_manager.listener_create_failure.rate | DEPENDENT | 0 |
| Listeners, create success | Total listener objects successfully added to workers per second. | envoy.listener_manager.listener_create_success.rate | DEPENDENT | 0 |
| Listeners, stopped | Total listeners stopped per second. | envoy.listener_manager.listener_stopped.rate | DEPENDENT | 0 |
| Listeners, active | Number of currently active listeners. | envoy.listener_manager.total_listeners_active | DEPENDENT | 0 |
| Listeners, draining | Number of currently draining listeners. | envoy.listener_manager.total_listeners_draining | DEPENDENT | 0 |
| Listener, warming | Number of currently warming listeners. | envoy.listener_manager.total_listeners_warming | DEPENDENT | 0 |
| Listener manager, initialized | A boolean (1 if started and 0 otherwise) that indicates whether listeners have been initialized on workers. | envoy.listener_manager.workers_started | DEPENDENT | 0 |
| Server concurrency | Number of worker threads. | envoy.server.concurrency | DEPENDENT | 0 |
| Certificate expiration, day before | Number of days until the next certificate being managed will expire. | envoy.server.days_until_first_cert_expiring | DEPENDENT | 0 |
| Server live | 1 if the server is not currently draining, 0 otherwise. | envoy.server.live | DEPENDENT | 0 |
| Memory allocated | Current amount of allocated memory in bytes. Total of both new and old Envoy processes on hot restart. | envoy.server.memory_allocated | DEPENDENT | 0 |
| Memory heap size | Current reserved heap size in bytes. New Envoy process heap size on hot restart. | envoy.server.memory_heap_size | DEPENDENT | 0 |
| Memory physical size | Current estimate of total bytes of the physical memory. New Envoy process physical memory size on hot restart. | envoy.server.memory_physical_size | DEPENDENT | 0 |
| Connections, parent | Total connections of the old Envoy process on hot restart. | envoy.server.parent_connections | DEPENDENT | 0 |
| Server state | State of the server.<br>Live - (default) Server is live and serving traffic.<br>Draining - Server is draining listeners in response to external health checks failing.<br>Pre initializing - Server has not yet completed cluster manager initialization.<br>Initializing - Server is running the cluster manager initialization callbacks (e.g., RDS). | envoy.server.state | DEPENDENT | 0 |
| Connections, total | Total connections of both new and old Envoy processes. | envoy.server.total_connections | DEPENDENT | 0 |
| Uptime | Current server uptime in seconds. | envoy.server.uptime | DEPENDENT | 0 |


<a name="macros"></a>

## Macros
| macro | value |
| ------------- |------------- |
| {$ENVOY.CERT.MIN} | 7 |
| {$ENVOY.METRICS.PATH} | /stats/prometheus |
| {$ENVOY.URL} | http://localhost:9901 |


<a name="triggers"></a>

## Triggers
| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| SSL certificate expires soon | WARNING | Please check certificate. Less than {$ENVOY.CERT.MIN} days left until the next certificate being managed will expire. | last(/Envoy Proxy by HTTP/envoy.server.days_until_first_cert_expiring)<{$ENVOY.CERT.MIN} | [{"tag": "scope", "value": "security"}] | no url |
| Server state is not live | AVERAGE | no description | last(/Envoy Proxy by HTTP/envoy.server.state) > 0 | [{"tag": "scope", "value": "availability"}] | no url |
| Failed to fetch metrics data | WARNING | Zabbix has not received data for items for the last 10 minutes. | nodata(/Envoy Proxy by HTTP/envoy.server.uptime,10m)=1 | [{"tag": "scope", "value": "availability"}] | no url |
| Service has been restarted | INFO | Uptime is less than 10 minutes. | last(/Envoy Proxy by HTTP/envoy.server.uptime)<10m | [{"tag": "scope", "value": "notice"}] | no url |


<a name="discoveries"></a>

## Discoveries
| name | key | description | type | lifetime | delay |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| Cluster metrics discovery | envoy.lld.cluster | no description | DEPENDENT | no lifetime | 0 |
| HTTP metrics discovery | envoy.lld.http | no description | DEPENDENT | no lifetime | 0 |
| Listeners metrics discovery | envoy.lld.listeners | no description | DEPENDENT | no lifetime | 0 |


<a name="discovery_cluster_metrics_discovery"></a>

## Discovery Cluster metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Cluster ["{#CLUSTER_NAME}"]: Membership, degraded | Current cluster degraded total. | envoy.cluster.membership_degraded["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Membership, healthy | Current cluster healthy total (inclusive of both health checking and outlier detection). | envoy.cluster.membership_healthy["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Membership, total | Current cluster membership total. | envoy.cluster.membership_total["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Membership, unhealthy | Current cluster unhealthy. | envoy.cluster.membership_unhealthy["{#CLUSTER_NAME}"] | CALCULATED |
| Cluster ["{#CLUSTER_NAME}"]: Connections, active | Current cluster total active connections. | envoy.cluster.upstream_cx_active["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Upstream bytes in, rate | Total received connection bytes per second. | envoy.cluster.upstream_cx_rx_bytes_total.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Connections, total | Current cluster total connections. | envoy.cluster.upstream_cx_total["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Upstream bytes out, rate | Total sent connection bytes per second. | envoy.cluster.upstream_cx_tx_bytes_total.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests 2xx, rate | Aggregate HTTP response codes per second. | envoy.cluster.upstream_rq_2x.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests 3xx, rate | Aggregate HTTP response codes per second. | envoy.cluster.upstream_rq_3x.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests 4xx, rate | Aggregate HTTP response codes per second. | envoy.cluster.upstream_rq_4x.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests 5xx, rate | Aggregate HTTP response codes per second. | envoy.cluster.upstream_rq_5x.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests active | Total active requests. | envoy.cluster.upstream_rq_active["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests completed, rate | Total upstream requests completed per second. | envoy.cluster.upstream_rq_completed.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests pending | Total active requests pending a connection pool connection. | envoy.cluster.upstream_rq_pending_active["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests timeout, rate | Current cluster requests that timed out waiting for a response per second. | envoy.cluster.upstream_rq_timeout.rate["{#CLUSTER_NAME}"] | DEPENDENT |
| Cluster ["{#CLUSTER_NAME}"]: Requests total, rate | Current cluster request total per second. | envoy.cluster.upstream_rq_total.rate["{#CLUSTER_NAME}"] | DEPENDENT |


### Triggers

| name | priority | description | expression | tags | url |
| ------------- |------------- |------------- |------------- |------------- |------------- |
| There are unhealthy clusters | AVERAGE | no description | last(/Envoy Proxy by HTTP/envoy.cluster.membership_unhealthy["{#CLUSTER_NAME}"]) > 0 | [{"tag": "scope", "value": "availability"}] | no url |


<a name="discovery_http_metrics_discovery"></a>

## Discovery HTTP metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| HTTP ["{#CONN_MANAGER}"]: Connections, active | Total active connections. | envoy.http.downstream_cx_active["{#CONN_MANAGER}"] | DEPENDENT |
| HTTP ["{#CONN_MANAGER}"]: Bytes in, rate | Total bytes received per second. | envoy.http.downstream_cx_rx_bytes_total.rate["{#CONN_MANAGER}"] | DEPENDENT |
| HTTP ["{#CONN_MANAGER}"]: Connections, rate | Total connections per second. | envoy.http.downstream_cx_total["{#CONN_MANAGER}"] | DEPENDENT |
| HTTP ["{#CONN_MANAGER}"]: Bytes out, rate | Total bytes sent per second. | envoy.http.downstream_cx_tx_bytes_tota.rate["{#CONN_MANAGER}"] | DEPENDENT |
| HTTP ["{#CONN_MANAGER}"]: Requests, active | Total active requests. | envoy.http.downstream_rq_active["{#CONN_MANAGER}"] | DEPENDENT |
| HTTP ["{#CONN_MANAGER}"]: Requests timeout, rate | Total requests closed due to a timeout on the request path per second. | envoy.http.downstream_rq_timeout["{#CONN_MANAGER}"] | DEPENDENT |
| HTTP ["{#CONN_MANAGER}"]: Requests, rate | Total active connections per second. | envoy.http.downstream_rq_total.rate["{#CONN_MANAGER}"] | DEPENDENT |


<a name="discovery_listeners_metrics_discovery"></a>

## Discovery Listeners metrics discovery

### Items

| name | description | key | type |
| ------------- |------------- |------------- |------------- |
| Listener ["{#LISTENER_ADDRESS}"]: Connections, active | Total active connections. | envoy.listener.downstream_cx_active["{#LISTENER_ADDRESS}"] | DEPENDENT |
| Listener ["{#LISTENER_ADDRESS}"]: Connections, rate | Total connections per second. | envoy.listener.downstream_cx_total.rate["{#LISTENER_ADDRESS}"] | DEPENDENT |
| Listener ["{#LISTENER_ADDRESS}"]: Sockets, undergoing | Sockets currently undergoing listener filter processing. | envoy.listener.downstream_pre_cx_active["{#LISTENER_ADDRESS}"] | DEPENDENT |

