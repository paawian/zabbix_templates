{
    "zabbix_export": {
        "version": "7.0",
        "template_groups": [
            {
                "uuid": "c2c162144c2d4c5491c8801193af4945",
                "name": "Templates/Cloud"
            }
        ],
        "templates": [
            {
                "uuid": "b43a7c5f1d1d43d28e2eb8f0a9f6f16f",
                "template": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                "name": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                "description": "Get GCP Cloud SQL PostgreSQL  monitoring for read-only replicas with script item usage to perform HTTP requests to Google Cloud Platform Monitoring API.\nThis template will be automatically connected to discovered entities with all their required parameters pre-defined.\n\nYou can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback.\n\n\nGenerated by official Zabbix template tool \"Templator\"",
                "vendor": {
                    "name": "Zabbix",
                    "version": "7.0-0"
                },
                "groups": [
                    {
                        "name": "Templates/Cloud"
                    }
                ],
                "items": [
                    {
                        "uuid": "c67dd812c7784948bad5dfa0d9a6cc66",
                        "name": "Flush location lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.flush_location",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "B",
                        "description": "Flush location replication lag in bytes.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.flush_location"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "2b8b51f0266049ffbfb7ece2f944fb68",
                        "name": "Number of log archival failures",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.log_archive_failure_count",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "Number of failed attempts for archiving replication log files.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.log_archive_failure_count"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "4657c4bb904b437598b68410e47f7194",
                        "name": "Number of log archival successes",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.log_archive_success_count",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "Number of failed attempts for archiving replication log files.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.log_archive_success_count"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "cb9c5aff913e4deeb29dfa1a20b5ff04",
                        "name": "Replica metrics get",
                        "type": "SCRIPT",
                        "key": "gcp.cloudsql.pgsql.repl.metrics.get",
                        "delay": "{$GCP.TIME.WINDOW}",
                        "history": "0",
                        "value_type": "TEXT",
                        "trends": "0",
                        "params": "var base_path = 'cloudsql.googleapis.com/database/replication/',\n\tpgsql_path = 'cloudsql.googleapis.com/database/postgresql/replication/',\n\tobj = {},\n\tbase_paths = ['network_lag', 'replica_lag', 'log_archive_failure_count', 'log_archive_success_count'];\n\nfunction getField(data, path) {\n\tvar steps = path.split('.');\n\n\tfor (var i = 0; i < steps.length; i++) {\n\t\tvar step = steps[i];\n\n\t\tif (typeof data !== 'object' || typeof data[step] === 'undefined') {\n\t\t\tthrow 'Required field \"' + path + '\" is not present in data received.';\n\t\t}\n\t\tdata = data[step];\n\t}\n\treturn data;\n}\n\nfunction checkParams(params) {\n\t['project_id', 'time_window', 'database_id', 'token'].forEach(function (field) {\n\t\tif (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {\n\t\t\tthrow 'Required param is not set: ' + field + '.';\n\t\t}\n\t});\n\tif (!params.time_window.match(/^[0-9]+(m|h)$/)) {\n\t\tthrow 'Incorrect update interval for parameter  time_window. Valid ranges 1m-23h.';\n\t}\n\treturn params;\n}\n\nfunction getHttpData(url, token, body) {\n\tvar request = new HttpRequest();\n\tif (typeof params.proxy !== 'undefined' && params.proxy !== '') {\n\t\trequest.setProxy(params.proxy);\n\t};\n\trequest.addHeader('Authorization: Bearer ' + token);\n\trequest.addHeader('Content-Type: application/json');\n\n\tvar response = request.post(url, JSON.stringify(body));\n\n\tif (response !== null) {\n\t\ttry {\n\t\t\tresponse = JSON.parse(response);\n\t\t}\n\t\tcatch (error) {\n\t\t\tthrow 'Failed to parse response received from GCP API. Check debug log for more information.';\n\t\t}\n\t}\n\n\tif (typeof response !== 'object' || response === null) {\n\t\tthrow 'Cannot process response data: received data is not an object. Check debug log for more information.';\n\t}\n\n\tif (request.getStatus() !== 200) {\n\t\tif (typeof (response.error && response.error.message) !== 'undefined') {\n\t\t\tthrow response.error.message;\n\t\t}\n\t\telse {\n\t\t\tthrow 'Failed to receive data: invalid response status code. Check debug log for more information.';\n\t\t}\n\t}\n\treturn response;\n};\n\nvar params = checkParams(JSON.parse(value)),\n\tfilter = ' | within ' + params.time_window + \" | filter database_id = '\" + params.database_id + \"'\",\n\tj_filter = filter + ' | join',\n\turl = 'https://monitoring.googleapis.com/v3/projects/' + params.project_id + '/timeSeries:query',\n\tmetric_raw = getHttpData(url, params.token, { query: '{' + base_paths.map(function (path) { return base_path + path; }).join(';') + '}' + j_filter }),\n\tmetric_keys = getField(metric_raw, 'timeSeriesDescriptor.pointDescriptors'),\n\tmetric_values = getField(metric_raw, 'timeSeriesData.0.pointData.0.values'),\n\tre = /(^t_\\d+\\.value\\.)/g;\n\nfor (i in metric_keys) {\n\tvar value_types = ['int64Value', 'doubleValue', 'stringValue', 'boolValue'];\n\n\tfor (v in value_types) {\n\t\tif (typeof metric_values[i][value_types[v]] !== 'undefined') {\n\t\t\tobj[getField(metric_keys[i], 'key').replace(re, '')] = metric_values[i][value_types[v]];\n\t\t}\n\t}\n}\n\nvar state_raw = getHttpData(url, params.token, { query: base_path + 'state' + filter }),\n\tstate_keys = getField(state_raw, 'timeSeriesDescriptor.pointDescriptors'),\n\tstate_tsd = getField(state_raw, 'timeSeriesData');\n\nfor (i in state_keys) {\n\tvar state_key = getField(state_keys[i], 'key').replace(/value\\./g, '');\n\n\tobj[state_key] = 'undefined';\n\tfor (t in state_tsd) {\n\t\tif (getField(state_tsd[t], 'pointData.0.values.' + i + '.boolValue') == true) {\n\t\t\tobj[state_key] = getField(state_tsd[t], 'labelValues.3.stringValue');\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nvar lag_raw = getHttpData(url, params.token, { query: pgsql_path + 'replica_byte_lag' + '| within ' + params.time_window + \" | filter replica_name = '\" + params.database_id + \"'\" }),\n\tlag_tsd = getField(lag_raw, 'timeSeriesData');\n\nfor (t in lag_tsd) {\n\tobj[getField(lag_tsd[t], 'labelValues.3.stringValue')] = getField(lag_tsd[t], 'pointData.0.values.0.int64Value');\n}\n\nreturn JSON.stringify(obj);",
                        "description": "PostgreSQL replica metrics data in raw format.",
                        "preprocessing": [
                            {
                                "type": "CHECK_NOT_SUPPORTED",
                                "parameters": [
                                    "-1"
                                ]
                            }
                        ],
                        "timeout": "{$GCP.DATA.TIMEOUT}",
                        "parameters": [
                            {
                                "name": "database_id",
                                "value": "{$GCP.PROJECT.ID}:{HOST.NAME}"
                            },
                            {
                                "name": "project_id",
                                "value": "{$GCP.PROJECT.ID}"
                            },
                            {
                                "name": "proxy",
                                "value": "{$GCP.PROXY}"
                            },
                            {
                                "name": "time_window",
                                "value": "{$GCP.TIME.WINDOW}"
                            },
                            {
                                "name": "token",
                                "value": "{$GCP.AUTH.TOKEN}"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "component",
                                "value": "raw"
                            }
                        ]
                    },
                    {
                        "uuid": "e43272210c45425d871d70a5bb91cdd1",
                        "name": "Network lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.network_lag",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "s",
                        "description": "Indicates time taken from primary binary log to IO thread on replica.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.network_lag"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "7d74736aa2804c899de35634bc072edf",
                        "name": "Replay location lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.replay_location",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "B",
                        "description": "Replay location replication lag in bytes.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.replay_location"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "192e0bb3ac744f8eb38a760ee3f7c623",
                        "name": "Replication lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.replica_lag",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "s",
                        "description": "Number of seconds the read replica is behind its primary (approximation).",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.replica_lag"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "379c8bc0cfe847d1819ab96aceee5efe",
                        "name": "Sent location lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.sent_location",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "B",
                        "description": "Sent location replication lag in bytes.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.sent_location"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "a7f785dbe4954d77a82e6384620b5d6e",
                        "name": "Replication state",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.state",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "The current serving state of replication.\nThis metric is only available for the MySQL/PostgreSQL instances.",
                        "valuemap": {
                            "name": "Replication state"
                        },
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.state"
                                ]
                            },
                            {
                                "type": "JAVASCRIPT",
                                "parameters": [
                                    "const idx = [\n\t'Running',\n\t'Syncing',\n\t'Unsynced',\n\t'Stopped',\n\t'Error',\n].indexOf(value);\nreturn idx !== -1 ? idx : 10;"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            },
                            {
                                "tag": "component",
                                "value": "status"
                            }
                        ]
                    },
                    {
                        "uuid": "10af15bc71ed446eb4e614c2cb6029d5",
                        "name": "Write location lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.pgsql.repl.write_location",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "B",
                        "description": "Write location replication lag in bytes.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.write_location"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.pgsql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    }
                ],
                "tags": [
                    {
                        "tag": "class",
                        "value": "cloud"
                    },
                    {
                        "tag": "target",
                        "value": "cloudsql"
                    },
                    {
                        "tag": "target",
                        "value": "gcp"
                    },
                    {
                        "tag": "target",
                        "value": "google-cloud-platform"
                    },
                    {
                        "tag": "target",
                        "value": "postgresql"
                    },
                    {
                        "tag": "target",
                        "value": "replica"
                    }
                ],
                "macros": [
                    {
                        "macro": "{$GCP.DATA.TIMEOUT}",
                        "value": "15s",
                        "description": "A response timeout for an API."
                    },
                    {
                        "macro": "{$GCP.PROXY}",
                        "description": "Sets HTTP proxy value. If this macro is empty then no proxy is used."
                    },
                    {
                        "macro": "{$GCP.TIME.WINDOW}",
                        "value": "5m",
                        "description": "Time interval for the data requests.\nSupported usage type:\n1. The default update interval for most of the items.\n2. The minimal time window for the data requested in the Monitoring Query Language REST API request."
                    }
                ],
                "dashboards": [
                    {
                        "uuid": "acb71f4a818d43e0b045ba87c2daa989",
                        "name": "PostgreSQL replica",
                        "pages": [
                            {
                                "name": "PostgreSQL replica",
                                "widgets": [
                                    {
                                        "type": "graph",
                                        "width": "36",
                                        "height": "5",
                                        "fields": [
                                            {
                                                "type": "GRAPH",
                                                "name": "graphid.0",
                                                "value": {
                                                    "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                                                    "name": "GCP Cloud SQL PostgreSQL: WAL archiving"
                                                }
                                            },
                                            {
                                                "type": "STRING",
                                                "name": "reference",
                                                "value": "AAAAA"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "graph",
                                        "x": "36",
                                        "width": "36",
                                        "height": "5",
                                        "fields": [
                                            {
                                                "type": "GRAPH",
                                                "name": "graphid.0",
                                                "value": {
                                                    "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                                                    "name": "GCP Cloud SQL PostgreSQL: Lags"
                                                }
                                            },
                                            {
                                                "type": "STRING",
                                                "name": "reference",
                                                "value": "AAAAB"
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "valuemaps": [
                    {
                        "uuid": "af111e6b9e5a47cd9c3933b8ce35076c",
                        "name": "Replication state",
                        "mappings": [
                            {
                                "value": "0",
                                "newvalue": "Running"
                            },
                            {
                                "value": "1",
                                "newvalue": "Syncing"
                            },
                            {
                                "value": "2",
                                "newvalue": "Unsynced"
                            },
                            {
                                "value": "3",
                                "newvalue": "Stopped"
                            },
                            {
                                "value": "4",
                                "newvalue": "Error"
                            },
                            {
                                "value": "10",
                                "newvalue": "Unknown"
                            }
                        ]
                    }
                ]
            }
        ],
        "graphs": [
            {
                "uuid": "30fe61bafae64ae6b29dacd68e9a6b3b",
                "name": "GCP Cloud SQL PostgreSQL: Lags",
                "graph_items": [
                    {
                        "color": "199C0D",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.network_lag"
                        }
                    },
                    {
                        "sortorder": "1",
                        "color": "F63100",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.replica_lag"
                        }
                    },
                    {
                        "sortorder": "2",
                        "color": "00611C",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.flush_location"
                        }
                    },
                    {
                        "sortorder": "3",
                        "color": "F7941D",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.replay_location"
                        }
                    },
                    {
                        "sortorder": "4",
                        "color": "FC6EA3",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.sent_location"
                        }
                    },
                    {
                        "sortorder": "5",
                        "color": "6C59DC",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.write_location"
                        }
                    }
                ]
            },
            {
                "uuid": "e96be84efaf7445fbfd8cf707b585fe7",
                "name": "GCP Cloud SQL PostgreSQL: WAL archiving",
                "graph_items": [
                    {
                        "color": "199C0D",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.log_archive_failure_count"
                        }
                    },
                    {
                        "sortorder": "1",
                        "color": "F63100",
                        "item": {
                            "host": "GCP Cloud SQL PostgreSQL Replica by HTTP",
                            "key": "gcp.cloudsql.pgsql.repl.log_archive_success_count"
                        }
                    }
                ]
            }
        ]
    }
}