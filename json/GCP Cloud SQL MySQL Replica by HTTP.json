{
    "zabbix_export": {
        "version": "7.0",
        "template_groups": [
            {
                "uuid": "c2c162144c2d4c5491c8801193af4945",
                "name": "Templates/Cloud"
            }
        ],
        "templates": [
            {
                "uuid": "9d7871c093f9489293421396b9fea668",
                "template": "GCP Cloud SQL MySQL Replica by HTTP",
                "name": "GCP Cloud SQL MySQL Replica by HTTP",
                "description": "Get GCP Cloud SQL MySQL monitoring for read-only replicas with script item usage to perform HTTP requests to Google Cloud Platform Monitoring API.\nThis template will be automatically connected to discovered entities with all their required parameters pre-defined.\n\nYou can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback.\n\n\nGenerated by official Zabbix template tool \"Templator\"",
                "vendor": {
                    "name": "Zabbix",
                    "version": "7.0-0"
                },
                "groups": [
                    {
                        "name": "Templates/Cloud"
                    }
                ],
                "items": [
                    {
                        "uuid": "17aa9eb4749e46be9b0b0f93ef011fca",
                        "name": "Last I/O thread error number",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.mysql.repl.last_io_errno",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "The error number of the most recent error that caused the I/O thread to stop.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.last_io_errno"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.mysql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "52c11965a2fc4d37a97ebccc04ee7b80",
                        "name": "Last SQL thread error number",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.mysql.repl.last_sql_errno",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "The error number of the most recent error that caused the SQL thread to stop.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.last_sql_errno"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.mysql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "470200d2cca348bb8a670a2be3a270e3",
                        "name": "Replica metrics get",
                        "type": "SCRIPT",
                        "key": "gcp.cloudsql.mysql.repl.metrics.get",
                        "delay": "{$GCP.TIME.WINDOW}",
                        "history": "0",
                        "value_type": "TEXT",
                        "trends": "0",
                        "params": "var base_path = 'cloudsql.googleapis.com/database/replication/',\n\tmysql_path = 'cloudsql.googleapis.com/database/mysql/replication/',\n\traw_metrics,\n\tobj = {},\n\tbase_paths = ['network_lag', 'replica_lag'].map(function (path) { return base_path + path; }),\n\tmysql_paths = [\n\t\t'last_io_errno',\n\t\t'last_sql_errno',\n\t\t'slave_io_running',\n\t\t'slave_sql_running'].map(function (path) { return mysql_path + path; }).concat(\n\t\t\t['network_lag', 'replica_lag'].map(function (path) { return base_path + path; }));\n\nfunction getField(data, path) {\n\tvar steps = path.split('.');\n\n\tfor (var i = 0; i < steps.length; i++) {\n\t\tvar step = steps[i];\n\n\t\tif (typeof data !== 'object' || typeof data[step] === 'undefined') {\n\t\t\tthrow 'Required field \"' + path + '\" is not present in data received.';\n\t\t}\n\t\tdata = data[step];\n\t}\n\treturn data;\n}\n\nfunction checkParams(params) {\n\t['project_id', 'time_window', 'database_id', 'token'].forEach(function (field) {\n\t\tif (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {\n\t\t\tthrow 'Required param is not set: ' + field + '.';\n\t\t}\n\t});\n\tif (!params.time_window.match(/^[0-9]+(m|h)$/)) {\n\t\tthrow 'Incorrect update interval for parameter  time_window. Valid ranges 1m-23h.';\n\t}\n\treturn params;\n}\n\nfunction getHttpData(url, token, body) {\n\tvar request = new HttpRequest();\n\tif (typeof params.proxy !== 'undefined' && params.proxy !== '') {\n\t\trequest.setProxy(params.proxy);\n\t};\n\trequest.addHeader('Authorization: Bearer ' + token);\n\trequest.addHeader('Content-Type: application/json');\n\n\tvar response = request.post(url, JSON.stringify(body));\n\n\tZabbix.log(4, '[ GCP API ] [ ' + url + ' ] Received response with status code ' + request.getStatus() + ': ' + response);\n\n\tif (response !== null) {\n\t\ttry {\n\t\t\tresponse = JSON.parse(response);\n\t\t}\n\t\tcatch (error) {\n\t\t\tthrow 'Failed to parse response received from GCP API. Check debug log for more information.';\n\t\t}\n\t}\n\n\tif (typeof response !== 'object' || response === null) {\n\t\tthrow 'Cannot process response data: received data is not an object. Check debug log for more information.';\n\t}\n\n\tif (request.getStatus() !== 200) {\n\t\tif (typeof (response.error && response.error.message) !== 'undefined') {\n\t\t\tthrow response.error.message;\n\t\t}\n\t\telse {\n\t\t\tthrow 'Failed to receive data: invalid response status code. Check debug log for more information.';\n\t\t}\n\t}\n\treturn response;\n};\n\nvar params = checkParams(JSON.parse(value)),\n\tfilter = ' | within ' + params.time_window + \" | filter database_id = '\" + params.database_id + \"'\",\n\tj_filter = filter + ' | join',\n\turl = 'https://monitoring.googleapis.com/v3/projects/' + params.project_id + '/timeSeries:query',\n\tmetric_raw = getHttpData(url, params.token, { query: '{' + mysql_paths.join(';') + '}' + j_filter }),\n\tmetric_keys = getField(metric_raw, 'timeSeriesDescriptor.pointDescriptors'),\n\tmetric_values = getField(metric_raw, 'timeSeriesData.0.pointData.0.values'),\n\tre = /(^t_\\d+\\.value\\.)/g;\n\nfor (i in metric_keys) {\n\tvar value_types = ['int64Value', 'doubleValue', 'stringValue', 'boolValue'];\n\n\tfor (v in value_types) {\n\t\tif (typeof metric_values[i][value_types[v]] !== 'undefined') {\n\t\t\tobj[getField(metric_keys[i], 'key').replace(re, \"\")] = metric_values[i][value_types[v]];\n\t\t}\n\t}\n}\n\nvar state_raw = getHttpData(url, params.token, { query: base_path + 'state' + filter }),\n\tstate_keys = getField(state_raw, 'timeSeriesDescriptor.pointDescriptors'),\n\tstate_tsd = getField(state_raw, 'timeSeriesData');\n\nfor (i in state_keys) {\n\tvar state_key = getField(state_keys[i], 'key').replace(/value\\./g, '');\n\n\tobj[state_key] = 'undefined';\n\tfor (t in state_tsd) {\n\t\tif (getField(state_tsd[t], 'pointData.0.values.' + i + '.boolValue') == true) {\n\t\t\tobj[state_key] = getField(state_tsd[t], 'labelValues.3.stringValue');\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nreturn JSON.stringify(obj);",
                        "description": "MySQL replication metrics data in raw format.",
                        "preprocessing": [
                            {
                                "type": "CHECK_NOT_SUPPORTED",
                                "parameters": [
                                    "-1"
                                ]
                            }
                        ],
                        "timeout": "{$GCP.DATA.TIMEOUT}",
                        "parameters": [
                            {
                                "name": "database_id",
                                "value": "{$GCP.PROJECT.ID}:{HOST.NAME}"
                            },
                            {
                                "name": "project_id",
                                "value": "{$GCP.PROJECT.ID}"
                            },
                            {
                                "name": "proxy",
                                "value": "{$GCP.PROXY}"
                            },
                            {
                                "name": "time_window",
                                "value": "{$GCP.TIME.WINDOW}"
                            },
                            {
                                "name": "token",
                                "value": "{$GCP.AUTH.TOKEN}"
                            }
                        ],
                        "tags": [
                            {
                                "tag": "component",
                                "value": "raw"
                            }
                        ]
                    },
                    {
                        "uuid": "e84ac3a2537848b29024659ab5e3a0e9",
                        "name": "Network lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.mysql.repl.network_lag",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "s",
                        "description": "Indicates time taken from primary binary log to IO thread on replica.",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.network_lag"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.mysql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "b5f9960de9414975ac48357844a15860",
                        "name": "Replication lag",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.mysql.repl.replica_lag",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "units": "s",
                        "description": "Number of seconds the read replica is behind its primary (approximation).",
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.replica_lag"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.mysql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "0c093a0416f24afb96fc28a7abb283d4",
                        "name": "Slave I/O thread running",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.mysql.repl.slave_io_running",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "Indicates whether the I/O thread for reading the primary's binary log is running.\nPossible values are Yes, No and Connecting.",
                        "valuemap": {
                            "name": "Thread state"
                        },
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.slave_io_running"
                                ]
                            },
                            {
                                "type": "JAVASCRIPT",
                                "parameters": [
                                    "const idx = [\n\t'No',\n\t'Yes',\n\t'Connecting',\n].indexOf(value);\nreturn idx !== -1 ? idx : 10;"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.mysql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "994d92340dd146a381f2e6bbebd1c3f2",
                        "name": "Slave SQL thread running",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.mysql.repl.slave_sql_running",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "Indicates whether the SQL thread for executing events in the relay log is running.",
                        "valuemap": {
                            "name": "Thread state"
                        },
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.slave_sql_running"
                                ]
                            },
                            {
                                "type": "BOOL_TO_DECIMAL",
                                "parameters": [
                                    ""
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.mysql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            }
                        ]
                    },
                    {
                        "uuid": "90a9154072164b5c89d715fa77e7e2b0",
                        "name": "Replication state",
                        "type": "DEPENDENT",
                        "key": "gcp.cloudsql.mysql.repl.state",
                        "delay": "0",
                        "history": "7d",
                        "trends": "90d",
                        "description": "The current serving state of replication.\nThis metric is only available for the MySQL/PostgreSQL instances.",
                        "valuemap": {
                            "name": "Replication state"
                        },
                        "preprocessing": [
                            {
                                "type": "JSONPATH",
                                "parameters": [
                                    "$.state"
                                ]
                            },
                            {
                                "type": "JAVASCRIPT",
                                "parameters": [
                                    "const idx = [\n\t'Running',\n\t'Syncing',\n\t'Unsynced',\n\t'Stopped',\n\t'Error',\n].indexOf(value);\nreturn idx !== -1 ? idx : 10;"
                                ]
                            }
                        ],
                        "master_item": {
                            "key": "gcp.cloudsql.mysql.repl.metrics.get"
                        },
                        "tags": [
                            {
                                "tag": "component",
                                "value": "replication"
                            },
                            {
                                "tag": "component",
                                "value": "status"
                            }
                        ]
                    }
                ],
                "tags": [
                    {
                        "tag": "class",
                        "value": "cloud"
                    },
                    {
                        "tag": "target",
                        "value": "cloudsql"
                    },
                    {
                        "tag": "target",
                        "value": "gcp"
                    },
                    {
                        "tag": "target",
                        "value": "google-cloud-platform"
                    },
                    {
                        "tag": "target",
                        "value": "mysql"
                    },
                    {
                        "tag": "target",
                        "value": "replica"
                    }
                ],
                "macros": [
                    {
                        "macro": "{$GCP.DATA.TIMEOUT}",
                        "value": "15s",
                        "description": "A response timeout for an API."
                    },
                    {
                        "macro": "{$GCP.PROXY}",
                        "description": "Sets HTTP proxy value. If this macro is empty then no proxy is used."
                    },
                    {
                        "macro": "{$GCP.TIME.WINDOW}",
                        "value": "5m",
                        "description": "Time interval for the data requests.\nSupported usage type:\n1. The default update interval for most of the items.\n2. The minimal time window for the data requested in the Monitoring Query Language REST API request."
                    }
                ],
                "dashboards": [
                    {
                        "uuid": "76eda12212f045388bef22cb382eff6b",
                        "name": "MySQL replica",
                        "pages": [
                            {
                                "name": "MySQL replica",
                                "widgets": [
                                    {
                                        "type": "graph",
                                        "width": "72",
                                        "height": "5",
                                        "fields": [
                                            {
                                                "type": "GRAPH",
                                                "name": "graphid.0",
                                                "value": {
                                                    "host": "GCP Cloud SQL MySQL Replica by HTTP",
                                                    "name": "GCP Cloud SQL MySQL: Lags"
                                                }
                                            },
                                            {
                                                "type": "STRING",
                                                "name": "reference",
                                                "value": "AAAAA"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "item",
                                        "name": "I/O Thread State",
                                        "y": "5",
                                        "width": "18",
                                        "height": "3",
                                        "fields": [
                                            {
                                                "type": "ITEM",
                                                "name": "itemid.0",
                                                "value": {
                                                    "host": "GCP Cloud SQL MySQL Replica by HTTP",
                                                    "key": "gcp.cloudsql.mysql.repl.slave_io_running"
                                                }
                                            },
                                            {
                                                "type": "INTEGER",
                                                "name": "show.0",
                                                "value": "2"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "item",
                                        "name": "I/O Thread Error",
                                        "x": "18",
                                        "y": "5",
                                        "width": "18",
                                        "height": "3",
                                        "fields": [
                                            {
                                                "type": "INTEGER",
                                                "name": "decimal_size",
                                                "value": "1"
                                            },
                                            {
                                                "type": "ITEM",
                                                "name": "itemid.0",
                                                "value": {
                                                    "host": "GCP Cloud SQL MySQL Replica by HTTP",
                                                    "key": "gcp.cloudsql.mysql.repl.last_io_errno"
                                                }
                                            },
                                            {
                                                "type": "INTEGER",
                                                "name": "show.0",
                                                "value": "2"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "item",
                                        "name": "SQL Thread State",
                                        "x": "36",
                                        "y": "5",
                                        "width": "18",
                                        "height": "3",
                                        "fields": [
                                            {
                                                "type": "INTEGER",
                                                "name": "decimal_size",
                                                "value": "1"
                                            },
                                            {
                                                "type": "ITEM",
                                                "name": "itemid.0",
                                                "value": {
                                                    "host": "GCP Cloud SQL MySQL Replica by HTTP",
                                                    "key": "gcp.cloudsql.mysql.repl.slave_sql_running"
                                                }
                                            },
                                            {
                                                "type": "INTEGER",
                                                "name": "show.0",
                                                "value": "2"
                                            }
                                        ]
                                    },
                                    {
                                        "type": "item",
                                        "name": "SQL Thread Error",
                                        "x": "54",
                                        "y": "5",
                                        "width": "18",
                                        "height": "3",
                                        "fields": [
                                            {
                                                "type": "INTEGER",
                                                "name": "decimal_size",
                                                "value": "1"
                                            },
                                            {
                                                "type": "ITEM",
                                                "name": "itemid.0",
                                                "value": {
                                                    "host": "GCP Cloud SQL MySQL Replica by HTTP",
                                                    "key": "gcp.cloudsql.mysql.repl.last_sql_errno"
                                                }
                                            },
                                            {
                                                "type": "INTEGER",
                                                "name": "show.0",
                                                "value": "2"
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ],
                "valuemaps": [
                    {
                        "uuid": "ea83090a16d94eb3bb643009c784d820",
                        "name": "Replication state",
                        "mappings": [
                            {
                                "value": "0",
                                "newvalue": "Running"
                            },
                            {
                                "value": "1",
                                "newvalue": "Syncing"
                            },
                            {
                                "value": "2",
                                "newvalue": "Unsynced"
                            },
                            {
                                "value": "3",
                                "newvalue": "Stopped"
                            },
                            {
                                "value": "4",
                                "newvalue": "Error"
                            },
                            {
                                "value": "10",
                                "newvalue": "Unknown"
                            }
                        ]
                    },
                    {
                        "uuid": "b1acfa66a401499cae56777db6c7750b",
                        "name": "Thread state",
                        "mappings": [
                            {
                                "value": "0",
                                "newvalue": "No"
                            },
                            {
                                "value": "1",
                                "newvalue": "Yes"
                            },
                            {
                                "value": "2",
                                "newvalue": "Connecting"
                            },
                            {
                                "value": "10",
                                "newvalue": "Unknown"
                            }
                        ]
                    }
                ]
            }
        ],
        "graphs": [
            {
                "uuid": "e94b7e8241b544e2beb4ea95db3e139f",
                "name": "GCP Cloud SQL MySQL: Lags",
                "graph_items": [
                    {
                        "color": "199C0D",
                        "item": {
                            "host": "GCP Cloud SQL MySQL Replica by HTTP",
                            "key": "gcp.cloudsql.mysql.repl.network_lag"
                        }
                    },
                    {
                        "sortorder": "1",
                        "color": "F63100",
                        "item": {
                            "host": "GCP Cloud SQL MySQL Replica by HTTP",
                            "key": "gcp.cloudsql.mysql.repl.replica_lag"
                        }
                    }
                ]
            }
        ]
    }
}